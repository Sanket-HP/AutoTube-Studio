<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoTube Studio Pro | AI Video Production</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --brand-red: #ef4444;
            --bg-deep: #050507;
            --bg-surface: #0e0e11;
            --border-muted: rgba(255,255,255,0.06);
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-deep);
            color: #fafafa;
            height: 100vh;
            overflow: hidden;
        }

        .mesh-gradient {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2;
            background: 
                radial-gradient(at 0% 0%, rgba(239, 68, 68, 0.1) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(239, 68, 68, 0.05) 0px, transparent 50%);
        }

        .glass-panel {
            background: rgba(14, 14, 17, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-muted);
        }

        .sidebar-item {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            color: #a1a1aa;
        }

        .sidebar-item.active {
            background: rgba(239, 68, 68, 0.1);
            color: var(--brand-red);
        }
        
        .sidebar-item.active::after {
            content: '';
            position: absolute;
            left: 0;
            top: 20%;
            height: 60%;
            width: 3px;
            background: var(--brand-red);
            border-radius: 0 4px 4px 0;
        }

        .input-field {
            background: #16161a !important;
            border: 1px solid var(--border-muted) !important;
            color: white !important;
            transition: border-color 0.2s;
        }

        .input-field:focus {
            border-color: var(--brand-red) !important;
            outline: none;
        }

        .custom-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #27272a; border-radius: 10px; }

        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .recording-active { animation: pulse-red 2s infinite; background: #991b1b !important; }

        .view-section { display: none; height: 100%; overflow-y: auto; padding-bottom: 100px; }
        .view-section.active { display: block; animation: fadeIn 0.4s ease-out; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        #player-canvas-container {
            width: 100%;
            aspect-ratio: 16/9;
            background: #000;
            border-radius: 20px;
            position: relative;
            overflow: hidden;
            border: 1px solid var(--border-muted);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .animate-spin-fast { animation: spin 0.8s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        .scene-card.active {
            border-color: var(--brand-red);
            background: rgba(239, 68, 68, 0.05);
        }
    </style>
</head>
<body class="flex flex-col">
    <div class="mesh-gradient"></div>

    <!-- HEADER -->
    <header class="h-16 border-b border-white/5 bg-black/40 backdrop-blur-xl flex items-center justify-between px-4 sm:px-6 shrink-0 z-50">
        <div class="flex items-center gap-3">
            <div class="w-9 h-9 bg-red-600 rounded-xl flex items-center justify-center font-black text-white italic shadow-lg shadow-red-600/30">AT</div>
            <div class="flex flex-col">
                <span class="font-extrabold tracking-tighter text-sm sm:text-base">AutoTube <span class="text-zinc-500 font-medium">Studio Pro</span></span>
                <span class="text-[8px] font-black text-zinc-600 uppercase tracking-[0.2em] hidden sm:block">AI Production Suite</span>
            </div>
        </div>
        
        <div class="flex items-center gap-4">
            <div id="status-container" class="flex items-center gap-2.5 px-3 py-1.5 rounded-full border border-zinc-800 bg-zinc-900/50">
                <div id="status-dot" class="w-1.5 h-1.5 rounded-full bg-zinc-600"></div>
                <span id="status-text" class="text-[10px] font-black text-zinc-500 uppercase tracking-tight">Offline</span>
            </div>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        <!-- SIDEBAR -->
        <aside class="hidden md:flex w-64 border-r border-white/5 p-4 flex-col gap-1.5 bg-[#08080a] shrink-0 z-40">
            <nav class="space-y-1 mt-4">
                <div onclick="switchPage('dashboard')" class="sidebar-item active flex items-center gap-3 p-3.5 rounded-xl cursor-pointer" data-page="dashboard">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
                    <span class="text-xs font-bold">Dashboard</span>
                </div>
                <div onclick="switchPage('script')" class="sidebar-item flex items-center gap-3 p-3.5 rounded-xl cursor-pointer" data-page="script">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                    <span class="text-xs font-bold">Architect</span>
                </div>
                <div onclick="switchPage('audio')" class="sidebar-item flex items-center gap-3 p-3.5 rounded-xl cursor-pointer" data-page="audio">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path></svg>
                    <span class="text-xs font-bold">Voiceover</span>
                </div>
                <div onclick="switchPage('production')" class="sidebar-item flex items-center gap-3 p-3.5 rounded-xl cursor-pointer" data-page="production">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                    <span class="text-xs font-bold">Mastering</span>
                </div>
            </nav>

            <div class="mt-auto p-5 glass-panel rounded-2xl">
                <span class="text-[9px] font-black text-zinc-500 uppercase tracking-widest block mb-2">Creator</span>
                <p class="text-[11px] font-bold text-zinc-300">Sanket Sarjerao Patil</p>
                <div class="h-px bg-zinc-800 my-3"></div>
                <button onclick="showInfo('terms')" class="text-[10px] text-zinc-500 hover:text-white underline">Privacy & Terms</button>
            </div>
        </aside>

        <!-- VIEWPORT -->
        <main class="flex-1 relative flex flex-col overflow-hidden bg-[#050507]">
            <!-- MOBILE TOP BAR NAV -->
            <div class="md:hidden flex bg-[#0c0c0e] border-b border-white/5 shrink-0 overflow-x-auto no-scrollbar">
                <div onclick="switchPage('dashboard')" class="flex-1 min-w-[80px] p-3 flex flex-col items-center gap-1">
                    <svg class="w-5 h-5 text-zinc-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6z"></path></svg>
                    <span class="text-[9px] font-bold uppercase">Dash</span>
                </div>
                <div onclick="switchPage('script')" class="flex-1 min-w-[80px] p-3 flex flex-col items-center gap-1">
                    <svg class="w-5 h-5 text-zinc-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5"></path></svg>
                    <span class="text-[9px] font-bold uppercase">Script</span>
                </div>
                <div onclick="switchPage('audio')" class="flex-1 min-w-[80px] p-3 flex flex-col items-center gap-1">
                    <svg class="w-5 h-5 text-zinc-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7"></path></svg>
                    <span class="text-[9px] font-bold uppercase">Voice</span>
                </div>
                <div onclick="switchPage('production')" class="flex-1 min-w-[80px] p-3 flex flex-col items-center gap-1">
                    <svg class="w-5 h-5 text-zinc-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764"></path></svg>
                    <span class="text-[9px] font-bold uppercase">Master</span>
                </div>
            </div>

            <div class="flex-1 overflow-hidden">
                <!-- VIEW: DASHBOARD -->
                <section id="view-dashboard" class="view-section active p-6 lg:p-12 custom-scrollbar">
                    <div class="max-w-6xl mx-auto space-y-8">
                        <div class="flex flex-col gap-1">
                            <h1 class="text-3xl sm:text-5xl font-black tracking-tighter text-white">Studio Dashboard</h1>
                            <p class="text-zinc-500 text-sm font-medium">Your end-to-end AI production pipeline.</p>
                        </div>

                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                            <div class="glass-panel p-6 rounded-3xl border-l-4 border-red-500">
                                <span class="text-[10px] font-black uppercase text-zinc-500 tracking-widest">Active Project</span>
                                <h3 id="dash-topic" class="text-lg font-bold mt-2 truncate text-white italic">None</h3>
                            </div>
                            <div class="glass-panel p-6 rounded-3xl" id="dash-script-card">
                                <span class="text-[10px] font-black uppercase text-zinc-500 tracking-widest">Blueprint</span>
                                <h3 id="dash-script-status" class="text-lg font-bold mt-2 text-zinc-500">Not Started</h3>
                            </div>
                            <div class="glass-panel p-6 rounded-3xl" id="dash-audio-card">
                                <span class="text-[10px] font-black uppercase text-zinc-500 tracking-widest">Voice Engine</span>
                                <h3 id="dash-audio-status" class="text-lg font-bold mt-2 text-zinc-500">Pending</h3>
                            </div>
                            <div class="glass-panel p-6 rounded-3xl" id="dash-video-card">
                                <span class="text-[10px] font-black uppercase text-zinc-500 tracking-widest">Asset Forge</span>
                                <h3 id="dash-video-status" class="text-lg font-bold mt-2 text-zinc-500">Ready</h3>
                            </div>
                        </div>

                        <div class="glass-panel rounded-[2.5rem] p-8 lg:p-20 text-center border-dashed border-zinc-800 flex flex-col items-center">
                            <div class="w-16 h-16 sm:w-20 sm:h-20 bg-red-600/10 rounded-full flex items-center justify-center mb-6 text-red-500">
                                <svg class="w-8 h-8 sm:w-10 sm:h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 4v16m8-8H4" stroke-width="3" stroke-linecap="round"></path></svg>
                            </div>
                            <h2 class="text-2xl sm:text-3xl font-bold mb-4 text-white">Start New Production</h2>
                            <p class="text-zinc-500 text-sm max-w-md mx-auto mb-8 font-medium">Link your AI gateway and input your topic to architect a viral video blueprint.</p>
                            <button onclick="switchPage('script')" class="w-full sm:w-auto px-10 py-4 bg-red-600 hover:bg-red-700 text-white font-black rounded-2xl shadow-xl transition-all">Go to Architect</button>
                        </div>
                    </div>
                </section>

                <!-- VIEW: SCRIPT ARCHITECT -->
                <section id="view-script" class="view-section p-6 lg:p-12 custom-scrollbar">
                    <div class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-8">
                        <div class="lg:col-span-5 space-y-6">
                            <div class="glass-panel p-6 rounded-3xl">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="text-[10px] font-black uppercase tracking-widest text-zinc-500">API Gateway</h3>
                                    <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-[10px] font-bold text-red-500 hover:underline">Get Key</a>
                                </div>
                                <div class="flex gap-2">
                                    <input type="password" id="api-key-input" class="input-field flex-1 px-4 py-2.5 rounded-xl text-sm" placeholder="Paste Gemini Key...">
                                    <button onclick="saveKey()" class="px-4 py-2.5 bg-white text-black text-[10px] font-black rounded-xl uppercase tracking-widest">Connect</button>
                                </div>
                            </div>
                            <div class="glass-panel p-6 rounded-3xl space-y-5">
                                <h3 class="text-[10px] font-black uppercase tracking-widest text-zinc-500">Production Prompt</h3>
                                <textarea id="topic-input" class="input-field w-full h-40 rounded-2xl p-5 text-sm resize-none leading-relaxed text-white" placeholder="Explain the mystery of black holes..."></textarea>
                                <button id="gen-script-btn" onclick="generateScript()" class="w-full py-4 bg-red-600 text-white font-black rounded-xl text-[10px] uppercase tracking-widest hover:bg-red-700">Write Script Blueprint</button>
                            </div>
                        </div>
                        <div class="lg:col-span-7">
                            <div class="glass-panel h-full min-h-[450px] rounded-[2rem] overflow-hidden flex flex-col">
                                <div class="flex border-b border-zinc-800 bg-zinc-900/30">
                                    <button onclick="switchScriptTab('full')" id="tab-full" class="flex-1 py-3 text-[10px] font-black uppercase tracking-widest text-white border-b-2 border-red-600">Full Script</button>
                                    <button onclick="switchScriptTab('scenes')" id="tab-scenes" class="flex-1 py-3 text-[10px] font-black uppercase tracking-widest text-zinc-500">Storyboard</button>
                                </div>
                                <div id="script-viewport" class="flex-1 p-6 text-sm text-zinc-400 leading-relaxed overflow-y-auto custom-scrollbar font-medium italic text-white">
                                    Generated output will appear here...
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- VIEW: VOICE STUDIO -->
                <section id="view-audio" class="view-section p-6 lg:p-12 custom-scrollbar">
                    <div class="max-w-4xl mx-auto">
                        <div class="glass-panel p-8 sm:p-12 rounded-[2.5rem] grid grid-cols-1 md:grid-cols-2 gap-10">
                            <div class="space-y-8">
                                <h3 class="text-2xl font-black tracking-tight text-white">Voice Studio</h3>
                                <div class="space-y-5">
                                    <div>
                                        <label class="block text-[10px] font-black text-zinc-500 uppercase tracking-widest mb-2">Persona</label>
                                        <select id="voice-name" class="input-field w-full p-4 rounded-xl text-sm font-bold text-white">
                                            <option value="Kore">Kore (Standard)</option>
                                            <option value="Zephyr">Zephyr (Deep)</option>
                                            <option value="Aoede">Aoede (Soft)</option>
                                            <option value="Charon">Charon (Bold)</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-[10px] font-black text-zinc-500 uppercase tracking-widest mb-2">Pacing</label>
                                        <select id="voice-tone" class="input-field w-full p-4 rounded-xl text-sm font-bold text-white">
                                            <option value="professional">Professional Narrative</option>
                                            <option value="energetic">Excited / Fast</option>
                                            <option value="calm">Slow / Educational</option>
                                        </select>
                                    </div>
                                </div>
                                <button id="gen-audio-btn" onclick="generateAudio()" class="w-full py-4 bg-red-600 text-white font-black rounded-xl shadow-xl shadow-red-600/10">Synthesize Audio</button>
                            </div>
                            <div class="flex flex-col items-center justify-center bg-black/40 rounded-3xl p-8 border border-zinc-800">
                                <div id="voice-loader" class="hidden w-12 h-12 border-4 border-red-600/20 border-t-red-600 rounded-full animate-spin-fast mb-4"></div>
                                <div id="audio-container" class="hidden w-full space-y-4">
                                    <p class="text-[10px] font-black text-green-500 uppercase text-center tracking-widest font-bold">Master Audio Ready</p>
                                    <audio id="main-audio" controls class="w-full h-10"></audio>
                                </div>
                                <p id="voice-placeholder" class="text-[10px] font-black text-zinc-600 uppercase tracking-[0.3em] text-center">Awaiting Data</p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- VIEW: MASTERING -->
                <section id="view-production" class="view-section p-4 lg:p-12 custom-scrollbar">
                    <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-8">
                        <div class="lg:col-span-8 space-y-6">
                            <div id="player-canvas-container">
                                <canvas id="export-canvas" width="1280" height="720" class="hidden"></canvas>
                                <img id="player-img" class="absolute inset-0 w-full h-full object-cover opacity-0 transition-opacity duration-500">
                                <div id="video-placeholder" class="absolute inset-0 flex flex-col items-center justify-center text-zinc-800">
                                    <svg class="w-12 h-12 mb-3 opacity-20" fill="currentColor" viewBox="0 0 20 20"><path d="M2 6a2 2 0 012-2h12a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6z"></path></svg>
                                    <p class="text-[10px] font-black uppercase tracking-[0.4em] opacity-30">Render Buffer Empty</p>
                                </div>
                                <div id="subtitle-box" class="absolute bottom-8 left-8 right-8 p-6 glass-panel rounded-2xl text-white text-xl font-bold text-center opacity-0 transform translate-y-4 transition-all duration-300"></div>
                                <div id="play-trigger" onclick="togglePlayback()" class="absolute inset-0 cursor-pointer flex items-center justify-center bg-black/20 opacity-0 hover:opacity-100 transition-all">
                                    <div class="w-20 h-20 bg-white text-black rounded-full flex items-center justify-center shadow-2xl scale-90 hover:scale-100 transition-transform">
                                        <svg id="play-icon" class="w-10 h-10 ml-1" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <button id="export-btn" onclick="exportMaster()" class="py-5 bg-white text-black font-black rounded-2xl text-xs uppercase tracking-[0.2em] shadow-xl hover:bg-zinc-200 transition-all disabled:opacity-30">Export Master Video</button>
                                <div class="h-16 glass-panel rounded-2xl flex items-center justify-center gap-4">
                                    <span class="text-[10px] font-black text-zinc-500 uppercase">TC</span>
                                    <span id="player-time" class="text-xl font-black font-mono text-white">00:00.00</span>
                                </div>
                            </div>
                        </div>

                        <div class="lg:col-span-4 space-y-6">
                            <div class="glass-panel p-6 rounded-3xl space-y-4">
                                <h3 class="text-[10px] font-black uppercase text-zinc-500 tracking-widest">Asset Manager</h3>
                                <button id="gen-visuals-btn" onclick="generateVisuals()" class="w-full py-4 bg-zinc-900 border border-white/5 hover:bg-zinc-800 text-white font-black rounded-xl text-[10px] uppercase transition-all">Forge Visual Assets</button>
                                <div id="asset-progress" class="flex gap-2 overflow-x-auto no-scrollbar py-1"></div>
                            </div>
                            <div class="glass-panel p-6 rounded-3xl space-y-4">
                                <h3 class="text-[10px] font-black uppercase text-zinc-500 tracking-widest">SEO Optimization</h3>
                                <div class="p-4 bg-black/40 rounded-xl border border-zinc-800">
                                    <span class="text-red-500 text-[9px] font-black uppercase block mb-1 font-bold">Title Target</span>
                                    <p id="seo-title" class="text-xs text-zinc-300 font-bold">---</p>
                                </div>
                                <div class="p-4 bg-black/40 rounded-xl border border-zinc-800">
                                    <span class="text-red-500 text-[9px] font-black uppercase block mb-1 font-bold">Meta Tags</span>
                                    <p id="seo-tags" class="text-[10px] text-zinc-500 font-medium leading-relaxed">---</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>

            <!-- FOOTER STATUS -->
            <footer class="h-16 border-t border-white/5 bg-black/80 backdrop-blur-xl flex items-center justify-between px-6 shrink-0 z-50">
                <div class="flex items-center gap-8">
                    <div class="flex items-center gap-2.5">
                        <div id="dot-script" class="w-1.5 h-1.5 rounded-full bg-zinc-800"></div>
                        <span class="text-[10px] font-bold text-zinc-500 uppercase">Script</span>
                    </div>
                    <div class="flex items-center gap-2.5">
                        <div id="dot-audio" class="w-1.5 h-1.5 rounded-full bg-zinc-800"></div>
                        <span class="text-[10px] font-bold text-zinc-500 uppercase">Voice</span>
                    </div>
                    <div class="flex items-center gap-2.5">
                        <div id="dot-visuals" class="w-1.5 h-1.5 rounded-full bg-zinc-800"></div>
                        <span class="text-[10px] font-bold text-zinc-500 uppercase">Visuals</span>
                    </div>
                </div>
                <button onclick="resetFactory()" class="text-zinc-600 hover:text-red-500 text-[10px] font-black uppercase tracking-widest transition-colors">Reset Studio</button>
            </footer>
        </main>
    </div>

    <div id="toast" class="fixed bottom-24 right-4 sm:right-8 transform translate-y-20 opacity-0 transition-all duration-500 z-[100] glass-panel px-6 py-4 rounded-2xl shadow-2xl border-white/10 pointer-events-none">
        <p id="toast-msg" class="text-xs font-bold text-zinc-200"></p>
    </div>

    <!-- MODAL -->
    <div id="info-modal" class="hidden fixed inset-0 z-[200] bg-black/80 backdrop-blur-md flex items-center justify-center p-6 text-white">
        <div class="glass-panel max-w-xl w-full rounded-[2.5rem] p-10 relative">
            <button onclick="closeModal()" class="absolute top-6 right-6 text-zinc-500 hover:text-white transition-all">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
            </button>
            <div id="modal-content" class="text-zinc-400 text-sm leading-relaxed font-medium"></div>
        </div>
    </div>

    <script>
        const ENGINE = {
            text: "gemini-2.5-flash-preview-09-2025",
            audio: "gemini-2.5-flash-preview-tts",
            image: "imagen-4.0-generate-001"
        };

        let state = {
            activePage: 'dashboard',
            apiKey: '',
            activeScriptTab: 'full',
            production: {
                topic: '',
                blueprint: null,
                audioUrl: null,
                visuals: [],
                visualImages: [],
                timings: []
            },
            isPlaying: false,
            isRecording: false,
            currentIdx: -1
        };

        // --- CORE NAVIGATION ---
        function switchPage(page) {
            document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.sidebar-item').forEach(s => s.classList.remove('active'));
            document.getElementById(`view-${page}`).classList.add('active');
            const navItem = document.querySelector(`.sidebar-item[data-page="${page}"]`);
            if(navItem) navItem.classList.add('active');
            state.activePage = page;
            renderView();
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').textContent = msg;
            t.classList.remove('opacity-0', 'translate-y-20');
            t.classList.add('opacity-100', 'translate-y-0');
            setTimeout(() => {
                t.classList.add('opacity-0', 'translate-y-20');
                t.classList.remove('opacity-100', 'translate-y-0');
            }, 3000);
        }

        function saveKey() {
            const val = document.getElementById('api-key-input').value.trim();
            if (val) {
                state.apiKey = val;
                document.getElementById('status-dot').className = "w-1.5 h-1.5 rounded-full bg-green-500 shadow-[0_0_10px_rgba(34,197,94,0.5)]";
                document.getElementById('status-text').textContent = "Engine Online";
                document.getElementById('status-text').className = "text-[10px] font-black text-green-500 uppercase";
                showToast("Gateway Connected!");
                saveState();
            }
        }

        function saveState() { localStorage.setItem('autotube_pro_v4', JSON.stringify(state)); }
        function loadState() {
            const saved = localStorage.getItem('autotube_pro_v4');
            if (saved) {
                state = JSON.parse(saved);
                document.getElementById('api-key-input').value = state.apiKey;
                document.getElementById('topic-input').value = state.production.topic;
                if(state.apiKey) saveKey();
                renderView();
            }
        }

        function resetFactory() {
            if(confirm("Factory Reset? Wipes current production.")) {
                localStorage.removeItem('autotube_pro_v4');
                location.reload();
            }
        }

        // --- API ENGINE ---
        async function apiCall(endpoint, payload, modelKey, retries = 5) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${ENGINE[modelKey]}:${endpoint}?key=${state.apiKey}`;
            let delay = 1000;

            for (let i = 0; i < retries; i++) {
                try {
                    const res = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (res.ok) return await res.json();
                    
                    const error = await res.json();
                    if (res.status === 429 || res.status >= 500) {
                        await new Promise(r => setTimeout(r, delay));
                        delay *= 2;
                        continue;
                    }
                    throw new Error(error.error?.message || "Engine Link Error");
                } catch (e) {
                    if (i === retries - 1) throw e;
                }
            }
        }

        // --- PRODUCTION LOGIC ---
        async function generateScript() {
            const topic = document.getElementById('topic-input').value.trim();
            if(!topic || !state.apiKey) return showToast("Topic and Key Required");

            const btn = document.getElementById('gen-script-btn');
            btn.disabled = true;
            btn.textContent = "ARCHITECTING BLUEPRINT...";

            const prompt = `YOUTUBE PRODUCTION ENGINE. Topic: "${topic}". Return JSON ONLY. NO MARKDOWN.
            {
                "title": "Viral Title",
                "full_text": "Complete narration text",
                "scenes": [{"narration": "one sentence", "prompt": "16:9 cinematic prompt"}],
                "seo": {"tags": "keyword1, keyword2", "hashtags": ["sanketpatil", "instastudio"]}
            }`;

            try {
                const data = await apiCall('generateContent', {
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: { responseMimeType: "application/json" }
                }, 'text');
                
                const raw = data.candidates[0].content.parts[0].text;
                state.production.blueprint = JSON.parse(raw);
                state.production.topic = topic;
                
                document.getElementById('dot-script').className = "w-1.5 h-1.5 rounded-full bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.4)]";
                document.getElementById('dash-script-status').textContent = "Generated";
                document.getElementById('dash-script-status').className = "text-lg font-bold mt-2 text-green-500";
                
                saveState();
                renderView();
                showToast("Production Blueprint Ready!");
            } catch (e) { showToast("Script Architect Failed"); console.error(e); }
            finally { btn.disabled = false; btn.textContent = "Write Script Blueprint"; }
        }

        async function generateAudio() {
            if(!state.production.blueprint) return showToast("No blueprint");
            const btn = document.getElementById('gen-audio-btn');
            btn.disabled = true;
            document.getElementById('voice-loader').classList.remove('hidden');
            document.getElementById('voice-placeholder').classList.add('hidden');

            // --- FIX: Strictly join scene narration to ensure length match ---
            const narrationText = state.production.blueprint.scenes.map(s => s.narration).join(' ');

            try {
                const data = await apiCall('generateContent', {
                    contents: [{ parts: [{ text: `Narrate in a ${document.getElementById('voice-tone').value} style: ${narrationText}` }] }],
                    generationConfig: {
                        responseModalities: ["AUDIO"],
                        speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: document.getElementById('voice-name').value } } }
                    }
                }, 'audio');

                const inline = data.candidates[0].content.parts.find(p => p.inlineData)?.inlineData;
                const binary = atob(inline.data);
                const bytes = new Uint8Array(binary.length);
                for(let i=0; i<binary.length; i++) bytes[i] = binary.charCodeAt(i);
                
                const blob = createWav(bytes, 24000);
                state.production.audioUrl = URL.createObjectURL(blob);
                
                const aud = document.getElementById('main-audio');
                aud.src = state.production.audioUrl;
                document.getElementById('audio-container').classList.remove('hidden');
                document.getElementById('dot-audio').className = "w-1.5 h-1.5 rounded-full bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.4)]";
                document.getElementById('dash-audio-status').textContent = "Mastered";
                document.getElementById('dash-audio-status').className = "text-lg font-bold mt-2 text-green-500";
                
                aud.onloadedmetadata = () => {
                    const dur = aud.duration;
                    const totalChars = state.production.blueprint.scenes.reduce((a, s) => a + s.narration.length, 0);
                    let elapsed = 0;
                    
                    // --- FIX: Calculate precise timings based on narration length vs total audio duration ---
                    state.production.timings = state.production.blueprint.scenes.map(s => {
                        const ratio = s.narration.length / totalChars;
                        const sceneDur = ratio * dur;
                        const timing = { start: elapsed, end: elapsed + sceneDur };
                        elapsed += sceneDur;
                        return timing;
                    });
                    saveState();
                };
                showToast("Narration Mastered!");
            } catch (e) { showToast("Audio Synth Error"); }
            finally { btn.disabled = false; document.getElementById('voice-loader').classList.add('hidden'); }
        }

        async function generateVisuals() {
            if(!state.production.blueprint) return showToast("No blueprint found");
            const btn = document.getElementById('gen-visuals-btn');
            btn.disabled = true;
            state.production.visuals = [];
            state.production.visualImages = [];
            const gallery = document.getElementById('asset-progress');
            gallery.innerHTML = '';

            const scenes = state.production.blueprint.scenes;
            try {
                for (let i = 0; i < scenes.length; i++) {
                    btn.textContent = `FORGING ASSET ${i+1}/${scenes.length}...`;
                    const data = await apiCall('predict', {
                        instances: { prompt: `Cinematic 4k high-fidelity YouTube background: ${scenes[i].prompt}` },
                        parameters: { sampleCount: 1 }
                    }, 'image');
                    
                    const b64 = `data:image/png;base64,${data.predictions[0].bytesBase64Encoded}`;
                    state.production.visuals.push(b64);
                    
                    const img = new Image();
                    img.src = b64;
                    state.production.visualImages.push(img);

                    const thumb = document.createElement('div');
                    thumb.className = "w-14 h-8 rounded-md overflow-hidden shrink-0 border border-white/10";
                    thumb.innerHTML = `<img src="${b64}" class="w-full h-full object-cover">`;
                    gallery.appendChild(thumb);
                }
                document.getElementById('dot-visuals').className = "w-1.5 h-1.5 rounded-full bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.4)]";
                document.getElementById('video-placeholder').classList.add('hidden');
                document.getElementById('player-img').src = state.production.visuals[0];
                document.getElementById('player-img').classList.remove('opacity-0');
                saveState();
                showToast("Visual Assets Forged!");
            } catch (e) { showToast("Asset Forge Error"); }
            finally { btn.disabled = false; btn.textContent = "Forge Visual Assets"; }
        }

        // --- UI RENDERING ---
        function renderView() {
            document.getElementById('dash-topic').textContent = state.production.topic || 'Untitled Production';
            
            if (state.activePage === 'script' && state.production.blueprint) {
                const viewport = document.getElementById('script-viewport');
                viewport.classList.remove('italic');
                if (state.activeScriptTab === 'full') {
                    viewport.textContent = state.production.blueprint.full_text;
                } else {
                    viewport.innerHTML = state.production.blueprint.scenes.map(s => `
                        <div class="p-4 glass-panel rounded-xl mb-3 border-l-2 border-red-600">
                            <p class="text-xs text-white font-bold">"${s.narration}"</p>
                            <p class="text-[10px] text-zinc-500 mt-2 italic">${s.prompt}</p>
                        </div>
                    `).join('');
                }
            }

            if (state.activePage === 'production' && state.production.blueprint) {
                document.getElementById('seo-title').textContent = state.production.blueprint.title;
                const mandatoryTags = "#sanketpatil #instastudio #creatorofinstastudiosanketpatil";
                document.getElementById('seo-tags').textContent = (state.production.blueprint.seo?.tags || "") + " " + mandatoryTags;
            }
        }

        function switchScriptTab(tab) {
            state.activeScriptTab = tab;
            document.getElementById('tab-full').className = `flex-1 py-3 text-[10px] font-black uppercase tracking-widest ${tab === 'full' ? 'text-white border-b-2 border-red-600' : 'text-zinc-500 border-transparent'}`;
            document.getElementById('tab-scenes').className = `flex-1 py-3 text-[10px] font-black uppercase tracking-widest ${tab === 'scenes' ? 'text-white border-b-2 border-red-600' : 'text-zinc-500 border-transparent'}`;
            renderView();
        }

        // --- COMPOSITOR & EXPORT ---
        const masterAudioPlayer = new Audio();
        
        function togglePlayback() {
            if (!state.production.audioUrl || state.production.visuals.length === 0) return showToast("Assets Incomplete");
            if (state.isPlaying) {
                masterAudioPlayer.pause();
                state.isPlaying = false;
                document.getElementById('play-icon').innerHTML = `<path d="M8 5v14l11-7z"/>`;
            } else {
                masterAudioPlayer.src = state.production.audioUrl;
                masterAudioPlayer.play();
                state.isPlaying = true;
                document.getElementById('play-icon').innerHTML = `<path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>`;
                requestAnimationFrame(productionLoop);
            }
        }

        function productionLoop() {
            if (!state.isPlaying && !state.isRecording) return;
            const time = masterAudioPlayer.currentTime;
            document.getElementById('player-time').textContent = formatTimer(time);

            // --- FIX: Improved scene finding logic for seamless transitions ---
            let idx = state.production.timings.findIndex(t => time >= t.start && time < t.end);
            
            // If at the very end, stay on the last scene
            if (idx === -1 && time > 0) idx = state.production.blueprint.scenes.length - 1;

            if (idx !== -1 && state.currentIdx !== idx) {
                state.currentIdx = idx;
                document.getElementById('player-img').src = state.production.visuals[idx];
                document.getElementById('player-img').style.opacity = "1";
                const sub = document.getElementById('subtitle-box');
                sub.textContent = state.production.blueprint.scenes[idx].narration;
                sub.style.opacity = "1";
                sub.style.transform = "translateY(0)";
            }
            
            if (state.isRecording) drawFrame(idx, time);
            requestAnimationFrame(productionLoop);
        }

        function drawFrame(idx, time) {
            const canvas = document.getElementById('export-canvas');
            const ctx = canvas.getContext('2d');
            const img = state.production.visualImages[idx >= 0 ? idx : 0];
            if (img && img.complete) {
                // Procedural Zoom for dynamic feel
                const scale = 1 + (time % 5) * 0.004;
                const w = 1280 * scale;
                const h = 720 * scale;
                ctx.drawImage(img, (1280 - w)/2, (720 - h)/2, w, h);
                
                // --- FIX: Subtitle Wrapping for final export ---
                const text = state.production.blueprint.scenes[idx >= 0 ? idx : 0].narration;
                ctx.fillStyle = "rgba(0,0,0,0.6)";
                ctx.fillRect(100, 580, 1080, 110);
                ctx.fillStyle = "white";
                ctx.font = "bold 28px 'Plus Jakarta Sans'";
                ctx.textAlign = "center";
                
                const words = text.split(' ');
                let line = '';
                let y = 625;
                for(let n = 0; n < words.length; n++) {
                    let test = line + words[n] + ' ';
                    if (ctx.measureText(test).width > 1000 && n > 0) {
                        ctx.fillText(line, 640, y);
                        line = words[n] + ' ';
                        y += 35;
                    } else line = test;
                }
                ctx.fillText(line, 640, y);

                // Professional Watermark
                ctx.fillStyle = "rgba(255,255,255,0.4)";
                ctx.font = "bold 16px 'Plus Jakarta Sans'";
                ctx.textAlign = "right";
                ctx.fillText("AUTOTUBE STUDIO PRO", 1250, 40);
            }
        }

        async function exportMaster() {
            if (state.isRecording) return;
            showToast("Syncing Stream Context... ðŸš€");
            state.isRecording = true;
            
            const btn = document.getElementById('export-btn');
            btn.disabled = true;
            btn.classList.add('recording-active');
            btn.textContent = "ENCODING MASTER...";

            // Setup Media Audio Stream Destination
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const dest = audioCtx.createMediaStreamDestination();
            const source = audioCtx.createMediaElementSource(masterAudioPlayer);
            source.connect(dest);
            source.connect(audioCtx.destination);

            const canvas = document.getElementById('export-canvas');
            const stream = canvas.captureStream(30);
            const combined = new MediaStream([...stream.getVideoTracks(), ...dest.stream.getAudioTracks()]);

            const recorder = new MediaRecorder(combined, { mimeType: 'video/webm;codecs=vp9,opus' });
            const chunks = [];
            
            recorder.ondataavailable = e => chunks.push(e.data);
            recorder.onstop = () => {
                const blob = new Blob(chunks, { type: 'video/webm' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `AutoTube_Studio_Pro_${Date.now()}.webm`;
                a.click();
                state.isRecording = false;
                btn.disabled = false;
                btn.classList.remove('recording-active');
                btn.textContent = "Export Master Video";
                showToast("Master Export Complete!");
            };

            masterAudioPlayer.currentTime = 0;
            masterAudioPlayer.play();
            recorder.start();
            state.isPlaying = true;
            masterAudioPlayer.onended = () => { recorder.stop(); state.isPlaying = false; };
        }

        // --- UTILS ---
        function createWav(pcm, rate) {
            const head = new ArrayBuffer(44);
            const v = new DataView(head);
            const s = (o, str) => { for (let i = 0; i < str.length; i++) v.setUint8(o + i, str.charCodeAt(i)); };
            s(0, 'RIFF'); v.setUint32(4, 36 + pcm.length, true); s(8, 'WAVE'); s(12, 'fmt ');
            v.setUint32(16, 16, true); v.setUint16(20, 1, true); v.setUint16(22, 1, true);
            v.setUint32(24, rate, true); v.setUint32(28, rate * 2, true); v.setUint16(32, 2, true); v.setUint16(34, 16, true);
            s(36, 'data'); v.setUint32(40, pcm.length, true);
            return new Blob([head, pcm], { type: 'audio/wav' });
        }

        function formatTimer(s) {
            const m = Math.floor(s / 60);
            const sec = Math.floor(s % 60);
            const ms = Math.floor((s % 1) * 100);
            return `${m.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}.${ms.toString().padStart(2,'0')}`;
        }

        function showInfo(type) {
            const modal = document.getElementById('info-modal');
            const content = document.getElementById('modal-content');
            if(type === 'terms') {
                content.innerHTML = `
                    <h2 class="text-3xl font-black mb-6 uppercase italic">Studio Disclaimer</h2>
                    <div class="space-y-4">
                        <p>AutoTube Studio Pro is a <span class="text-red-500 font-bold">100% Client-Side Production Engine</span>. Your API keys and data never touch our servers.</p>
                        <p>Designed and Produced by <span class="text-white font-black underline decoration-red-600">Sanket Sarjerao Patil</span>. Rights Reserved.</p>
                        <p>Generated content relies on Google AI Studio APIs. By using this tool, you agree to their Terms of Service and Safety Policies.</p>
                    </div>`;
            }
            modal.style.display = 'flex';
        }

        function closeModal() { document.getElementById('info-modal').style.display = 'none'; }
        window.onload = loadState;
    </script>
</body>
</html>