<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoTube Studio | Pro AI Production</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --yt-red: #ff0000;
            --bg-deep: #050505;
            --bg-surface: #0f0f0f;
            --border-muted: rgba(255,255,255,0.06);
            color-scheme: dark;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-deep);
            color: #fafafa;
            height: 100vh;
            overflow: hidden;
        }

        @media (max-width: 1024px) {
            body { overflow-y: auto; height: auto; min-height: 100vh; }
        }

        .mesh-gradient {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%; z-index: -2;
            background: 
                radial-gradient(at 0% 0%, rgba(255, 0, 0, 0.08) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(255, 0, 0, 0.04) 0px, transparent 50%);
        }

        .glass-panel {
            background: rgba(18, 18, 18, 0.8);
            backdrop-filter: blur(24px);
            border: 1px solid var(--border-muted);
        }

        .sidebar-item {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            color: #888888;
        }

        .sidebar-item.active {
            background: rgba(255, 0, 0, 0.08);
            color: #ffffff;
        }
        
        .sidebar-item.active::after {
            content: '';
            position: absolute;
            left: 0; top: 25%; height: 50%; width: 3px;
            background: var(--yt-red);
            border-radius: 0 4px 4px 0;
            box-shadow: 0 0 10px var(--yt-red);
        }

        .input-field {
            background: #0a0a0a !important;
            border: 1px solid var(--border-muted) !important;
            color: white !important;
            transition: all 0.2s ease;
        }

        .input-field:focus { border-color: var(--yt-red) !important; outline: none; box-shadow: 0 0 0 1px var(--yt-red); }

        .custom-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #222; border-radius: 10px; }

        .view-section { display: none; height: 100%; overflow-y: auto; padding-bottom: 100px; }
        .view-section.active { display: block; animation: fadeIn 0.4s ease-out; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        #player-canvas-container {
            width: 100%;
            aspect-ratio: 16/9;
            background: #000;
            border-radius: 24px;
            position: relative;
            overflow: hidden;
            border: 1px solid var(--border-muted);
            box-shadow: 0 30px 60px -12px rgba(0, 0, 0, 0.8);
        }

        #player-canvas-container canvas {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .asset-thumb {
            width: 68px;
            height: 38px;
            border-radius: 8px;
            background: #0a0a0a;
            flex-shrink: 0;
            border: 1px solid rgba(255,255,255,0.05);
            overflow: hidden;
            transition: transform 0.2s ease;
        }
        
        .asset-thumb.loading {
            border-color: var(--yt-red);
            animation: pulse-red 1.5s infinite;
        }

        .active-scene-card {
            border-left: 3px solid var(--yt-red) !important;
            background: rgba(255,0,0,0.05) !important;
            transform: translateX(4px);
        }

        @keyframes pulse-red {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body class="flex flex-col">
    <div class="mesh-gradient"></div>

    <!-- HEADER -->
    <header class="h-16 border-b border-white/5 bg-black/40 backdrop-blur-xl flex items-center justify-between px-4 sm:px-8 shrink-0 z-50">
        <div class="flex items-center gap-4">
            <div class="w-10 h-10 bg-red-600 rounded-2xl flex items-center justify-center shadow-xl shadow-red-600/20">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect><path d="M10 15l4-3-4-3v6z" fill="white"></path></svg>
            </div>
            <div class="flex flex-col">
                <span class="font-black tracking-tighter text-sm sm:text-xl uppercase italic">AutoTube <span class="text-red-600">Studio</span></span>
                <span class="text-[8px] font-black text-zinc-500 uppercase tracking-[0.3em]">Precision Node v5.5</span>
            </div>
        </div>
        
        <div class="flex items-center gap-4">
            <div id="status-container" class="flex items-center gap-2 px-4 py-2 rounded-full border border-zinc-800 bg-zinc-900/40">
                <div id="status-dot" class="w-2 h-2 rounded-full bg-zinc-600"></div>
                <span id="status-text" class="text-[10px] font-black text-zinc-500 uppercase tracking-widest">Client Ready</span>
            </div>
        </div>
    </header>

    <div class="flex flex-1 flex-col lg:flex-row overflow-hidden">
        <!-- SIDEBAR -->
        <aside class="w-full lg:w-72 border-b lg:border-b-0 lg:border-r border-white/5 p-4 flex flex-row lg:flex-col gap-2 bg-[#050505] shrink-0 z-40 overflow-x-auto custom-scrollbar">
            <nav class="flex flex-row lg:flex-col flex-1 gap-2 lg:mt-6">
                <div id="nav-dashboard" onclick="switchPage('dashboard')" class="sidebar-item active flex items-center gap-4 p-4 rounded-2xl cursor-pointer whitespace-nowrap lg:w-full group">
                    <svg class="w-5 h-5 opacity-50 group-hover:opacity-100" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6z"></path></svg>
                    <span class="text-[11px] font-black uppercase tracking-widest">Dashboard</span>
                </div>
                <div id="nav-script" onclick="switchPage('script')" class="sidebar-item flex items-center gap-4 p-4 rounded-2xl cursor-pointer whitespace-nowrap lg:w-full group">
                    <svg class="w-5 h-5 opacity-50 group-hover:opacity-100" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                    <span class="text-[11px] font-black uppercase tracking-widest">Script Architect</span>
                </div>
                <div id="nav-audio" onclick="switchPage('audio')" class="sidebar-item flex items-center gap-4 p-4 rounded-2xl cursor-pointer whitespace-nowrap lg:w-full group">
                    <svg class="w-5 h-5 opacity-50 group-hover:opacity-100" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path></svg>
                    <span class="text-[11px] font-black uppercase tracking-widest">Voice Studio</span>
                </div>
                <div id="nav-production" onclick="switchPage('production')" class="sidebar-item flex items-center gap-4 p-4 rounded-2xl cursor-pointer whitespace-nowrap lg:w-full group">
                    <svg class="w-5 h-5 opacity-50 group-hover:opacity-100" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                    <span class="text-[11px] font-black uppercase tracking-widest">Mastering</span>
                </div>
            </nav>

            <div class="hidden lg:block mt-auto p-6 glass-panel rounded-3xl border border-white/5">
                <span class="text-[9px] font-black text-zinc-500 uppercase tracking-[0.2em] block mb-3">System Health</span>
                <div class="flex items-center justify-between mb-4">
                    <span class="text-[10px] text-zinc-400">Memory Load</span>
                    <span class="text-[10px] font-bold text-green-500">Low</span>
                </div>
                <button onclick="confirmReset()" class="w-full py-3 bg-zinc-800/50 hover:bg-red-950/30 text-zinc-500 hover:text-red-500 text-[10px] font-black uppercase tracking-widest rounded-xl transition-colors">Hard Reset</button>
            </div>
        </aside>

        <!-- VIEWPORT -->
        <main class="flex-1 relative flex flex-col overflow-hidden bg-[#020202]">
            <div class="flex-1 overflow-hidden">
                <!-- VIEW: DASHBOARD -->
                <section id="view-dashboard" class="view-section active p-4 sm:p-12 custom-scrollbar">
                    <div class="max-w-6xl mx-auto space-y-10">
                        <div class="flex flex-col gap-2">
                            <h1 class="text-4xl sm:text-5xl font-black tracking-tighter text-white uppercase italic">Studio Overview</h1>
                            <p class="text-zinc-500 text-xs sm:text-base font-medium">Manage your production assets and real-time synthesis status.</p>
                        </div>

                        <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-4">
                            <div class="glass-panel p-8 rounded-[2rem] border-l-4 border-red-600 shadow-2xl">
                                <span class="text-[10px] font-black uppercase text-zinc-500 tracking-[0.2em]">Project</span>
                                <h3 id="dash-topic" class="text-lg font-bold mt-2 truncate text-white italic">None</h3>
                            </div>
                            <div class="glass-panel p-8 rounded-[2rem] border border-white/5">
                                <span class="text-[10px] font-black uppercase text-zinc-500 tracking-[0.2em]">Script</span>
                                <h3 id="dash-script-status" class="text-lg font-bold mt-2 text-zinc-600">Pending</h3>
                            </div>
                            <div class="glass-panel p-8 rounded-[2rem] border border-white/5">
                                <span class="text-[10px] font-black uppercase text-zinc-500 tracking-[0.2em]">Audio</span>
                                <h3 id="dash-audio-status" class="text-lg font-bold mt-2 text-zinc-600">Waiting</h3>
                            </div>
                            <div class="glass-panel p-8 rounded-[2rem] border border-white/5">
                                <span class="text-[10px] font-black uppercase text-zinc-500 tracking-[0.2em]">Media</span>
                                <h3 id="dash-video-status" class="text-lg font-bold mt-2 text-zinc-600">Idle</h3>
                            </div>
                        </div>

                        <div id="stats-panel" class="hidden grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div class="glass-panel p-6 rounded-3xl flex justify-between items-center border border-white/5">
                                <span class="text-[11px] font-black text-zinc-500 uppercase tracking-widest">Runtime Estimate</span>
                                <span id="stat-duration" class="text-sm font-bold text-white font-mono">0.00s</span>
                            </div>
                            <div class="glass-panel p-6 rounded-3xl flex justify-between items-center border border-white/5">
                                <span class="text-[11px] font-black text-zinc-500 uppercase tracking-widest">Total Words</span>
                                <span id="stat-words" class="text-sm font-bold text-white font-mono">0</span>
                            </div>
                        </div>

                        <div class="glass-panel rounded-[3rem] p-12 sm:p-24 text-center border-dashed border-zinc-800 flex flex-col items-center">
                            <div class="w-20 h-20 bg-red-600/10 rounded-3xl flex items-center justify-center mb-8 text-red-600 rotate-3">
                                <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 4v16m8-8H4" stroke-width="3" stroke-linecap="round"></path></svg>
                            </div>
                            <h2 class="text-3xl font-black mb-6 text-white uppercase italic">Initialize Synthesis</h2>
                            <p class="text-zinc-500 text-sm max-w-lg mx-auto mb-10 font-medium leading-relaxed">Define your concept in the Architect module. Our engine will synthesize narration and visual frames in a sandboxed local environment.</p>
                            <button onclick="switchPage('script')" class="w-full sm:w-auto px-12 py-5 bg-red-600 hover:bg-red-700 text-white font-black rounded-2xl shadow-2xl shadow-red-600/20 transition-all active:scale-95 text-xs uppercase tracking-widest">Access Architect</button>
                        </div>
                    </div>
                </section>

                <!-- VIEW: SCRIPT ARCHITECT -->
                <section id="view-script" class="view-section p-4 sm:p-12 custom-scrollbar">
                    <div class="max-w-7xl mx-auto grid grid-cols-1 xl:grid-cols-12 gap-8">
                        <div class="xl:col-span-5 space-y-6">
                            <div class="glass-panel p-8 rounded-[2rem]">
                                <div class="flex items-center justify-between mb-6">
                                    <h3 class="text-[11px] font-black uppercase tracking-[0.2em] text-zinc-500">API Gateway</h3>
                                    <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-[10px] font-bold text-red-600 hover:underline">Get Key</a>
                                </div>
                                <div class="flex gap-2">
                                    <input type="password" id="api-key-input" class="input-field flex-1 px-5 py-4 rounded-2xl text-sm" placeholder="Paste Gemini Key...">
                                    <button id="verify-btn" onclick="saveKey()" class="px-6 py-4 bg-white text-black text-[11px] font-black rounded-2xl uppercase active:scale-95 transition-transform">Link</button>
                                </div>
                            </div>
                            <div class="glass-panel p-8 rounded-[2rem] space-y-6">
                                <h3 class="text-[11px] font-black uppercase tracking-[0.2em] text-zinc-500">Creative Concept</h3>
                                <textarea id="topic-input" class="input-field w-full h-48 rounded-2xl p-6 text-sm resize-none text-white font-medium leading-relaxed" placeholder="Describe your video goal... (e.g. 5 surprising space facts that sound fake)"></textarea>
                                <button id="gen-script-btn" onclick="generateScript()" class="w-full py-5 bg-red-600 text-white font-black rounded-2xl text-[11px] uppercase hover:bg-red-700 active:scale-95 transition-all tracking-[0.1em]">Construct Blueprint</button>
                            </div>
                        </div>
                        <div class="xl:col-span-7">
                            <div class="glass-panel h-full min-h-[500px] rounded-[2.5rem] overflow-hidden flex flex-col border border-white/5">
                                <div class="flex border-b border-zinc-900 bg-zinc-900/20">
                                    <button onclick="switchScriptTab('full')" id="tab-full" class="flex-1 py-4 text-[11px] font-black uppercase tracking-widest text-white border-b-2 border-red-600 transition-all">Full Narration</button>
                                    <button onclick="switchScriptTab('scenes')" id="tab-scenes" class="flex-1 py-4 text-[11px] font-black uppercase tracking-widest text-zinc-500 transition-all">Storyboard View</button>
                                </div>
                                <div id="script-viewport" class="flex-1 p-8 text-sm text-zinc-400 leading-loose overflow-y-auto custom-scrollbar font-medium italic">
                                    Final production blueprint will be displayed here after generation.
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- VIEW: VOICE STUDIO -->
                <section id="view-audio" class="view-section p-4 sm:p-12 custom-scrollbar">
                    <div class="max-w-5xl mx-auto">
                        <div class="glass-panel p-8 sm:p-16 rounded-[3rem] grid grid-cols-1 md:grid-cols-2 gap-12 border border-white/5 shadow-2xl">
                            <div class="space-y-10">
                                <div class="flex flex-col gap-2">
                                    <h3 class="text-3xl font-black tracking-tighter text-white uppercase italic">Voice Forge</h3>
                                    <p class="text-zinc-500 text-xs font-bold uppercase tracking-widest">Select Narrative Persona</p>
                                </div>
                                <div class="space-y-6">
                                    <div>
                                        <label class="block text-[10px] font-black text-zinc-500 uppercase tracking-widest mb-3">Speaker Profile</label>
                                        <select id="voice-name" class="input-field w-full p-5 rounded-2xl text-sm font-bold text-white appearance-none cursor-pointer">
                                            <optgroup label="Female Voice Profiles">
                                                <option value="Kore">Kore (Bright & Professional)</option>
                                                <option value="Aoede">Aoede (Gentle & Academic)</option>
                                                <option value="Leda">Leda (Crisp & Energetic)</option>
                                                <option value="Callirrhoe">Callirrhoe (Soft & Warm)</option>
                                                <option value="Autonoe">Autonoe (Sophisticated)</option>
                                            </optgroup>
                                            <optgroup label="Male Voice Profiles">
                                                <option value="Zephyr">Zephyr (Deep & Narrative)</option>
                                                <option value="Charon">Charon (Bold & Action)</option>
                                                <option value="Fenrir">Fenrir (Aggressive & Strong)</option>
                                                <option value="Orus">Orus (Steady & Trustworthy)</option>
                                                <option value="Algenib">Algenib (Casual & Friendly)</option>
                                            </optgroup>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-[10px] font-black text-zinc-500 uppercase tracking-widest mb-3">Target Language</label>
                                        <input type="text" id="target-language" class="input-field w-full p-5 rounded-2xl text-sm font-bold text-white" placeholder="e.g. Hindi, French, Spanish, Marathi...">
                                    </div>
                                    <button id="gen-audio-btn" onclick="generateAudio()" class="w-full py-5 bg-red-600 text-white font-black rounded-2xl shadow-2xl shadow-red-600/10 active:scale-95 transition-all text-[11px] uppercase tracking-widest">Synthesize Narration</button>
                                </div>
                            </div>
                            <div class="flex flex-col items-center justify-center bg-black/50 rounded-[2.5rem] p-10 border border-zinc-800/50 min-h-[300px] shadow-inner">
                                <div id="voice-loader" class="hidden w-16 h-16 border-4 border-red-600/10 border-t-red-600 rounded-full animate-spin mb-6"></div>
                                <div id="audio-container" class="hidden w-full space-y-8 text-center">
                                    <div class="flex flex-col items-center gap-4">
                                        <div class="w-20 h-20 bg-green-500/10 rounded-full flex items-center justify-center text-green-500 shadow-xl shadow-green-500/10">
                                            <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                                        </div>
                                        <p class="text-[10px] font-black text-green-500 uppercase tracking-[0.3em]">Narration Ready</p>
                                        <p id="audio-duration-text" class="text-sm text-zinc-400 font-mono tracking-widest">00:00.00 / 00:00.00</p>
                                    </div>
                                    <button id="voice-play-pause-btn" onclick="togglePlayback()" class="w-full py-5 bg-white text-black font-black rounded-2xl flex items-center justify-center gap-3 active:scale-95 transition-transform">
                                        <svg id="voice-play-icon" class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                                        <span id="voice-play-text" class="text-[11px] uppercase tracking-widest">Preview Audio</span>
                                    </button>
                                </div>
                                <div id="voice-placeholder" class="text-center">
                                    <p class="text-[10px] font-black text-zinc-700 uppercase tracking-[0.4em]">Awaiting Generation</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- VIEW: MASTERING -->
                <section id="view-production" class="view-section p-4 sm:p-12 custom-scrollbar">
                    <div class="max-w-[1400px] mx-auto grid grid-cols-1 xl:grid-cols-12 gap-8">
                        <div class="xl:col-span-8 space-y-8">
                            <div id="player-canvas-container">
                                <canvas id="main-canvas" width="1280" height="720"></canvas>
                                <div id="video-placeholder" class="absolute inset-0 flex flex-col items-center justify-center text-zinc-900 px-6 text-center pointer-events-none">
                                    <svg class="w-16 h-16 mb-4 opacity-10" fill="currentColor" viewBox="0 0 20 20"><path d="M2 6a2 2 0 012-2h12a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6z"></path></svg>
                                    <p class="text-[12px] font-black uppercase tracking-[0.5em] opacity-20">Buffer Awaiting Frames</p>
                                </div>
                                <div id="play-trigger" onclick="togglePlayback()" class="absolute inset-0 cursor-pointer flex items-center justify-center bg-black/10 opacity-0 hover:opacity-100 transition-all z-10">
                                    <div class="w-24 h-24 bg-white text-black rounded-full flex items-center justify-center shadow-2xl scale-90 hover:scale-100 transition-transform">
                                        <svg id="play-icon" class="w-12 h-12 ml-1" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <button id="export-btn" onclick="exportMaster()" class="py-6 bg-white text-black font-black rounded-3xl text-xs uppercase tracking-[0.3em] shadow-2xl hover:bg-zinc-100 active:scale-95 transition-all">
                                    Encode Master Production
                                </button>
                                <div class="glass-panel rounded-3xl flex flex-col items-center justify-center py-5 gap-1 border border-white/5">
                                    <span class="text-[10px] font-black text-zinc-600 uppercase tracking-widest">Master Clock</span>
                                    <span id="player-time" class="text-2xl sm:text-4xl font-black font-mono text-white tracking-tighter">00:00.00</span>
                                </div>
                            </div>
                        </div>

                        <div class="xl:col-span-4 space-y-8">
                            <div class="glass-panel p-8 rounded-[2.5rem] space-y-6 border border-white/5 shadow-xl">
                                <h3 class="text-[11px] font-black uppercase text-zinc-500 tracking-[0.2em]">Asset Pipeline</h3>
                                <button id="gen-visuals-btn" onclick="generateVisuals()" class="w-full py-5 bg-zinc-900 border border-white/10 hover:bg-zinc-800 text-white font-black rounded-2xl text-[10px] uppercase tracking-widest transition-colors active:scale-95">Generate Master Frames</button>
                                <div id="asset-progress" class="flex gap-3 overflow-x-auto custom-scrollbar py-2"></div>
                            </div>

                            <div class="glass-panel p-8 rounded-[2.5rem] space-y-6 border border-white/5 shadow-xl">
                                <h3 class="text-[11px] font-black uppercase text-zinc-500 tracking-[0.2em]">SEO Metadata</h3>
                                <div class="space-y-4">
                                    <div class="p-5 bg-black/60 rounded-2xl border border-zinc-900 group">
                                        <span class="text-red-600 text-[10px] font-black uppercase block mb-2 tracking-widest">Strategic Title</span>
                                        <p id="seo-title" class="text-sm text-zinc-200 font-bold leading-relaxed truncate group-hover:whitespace-normal">---</p>
                                    </div>
                                    <div class="p-5 bg-black/60 rounded-2xl border border-zinc-900">
                                        <span class="text-red-600 text-[10px] font-black uppercase block mb-2 tracking-widest">Target Keywords</span>
                                        <p id="seo-tags" class="text-[10px] text-zinc-500 font-medium leading-relaxed italic line-clamp-2">---</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>

            <footer class="h-16 border-t border-white/5 bg-black/80 backdrop-blur-2xl flex items-center justify-between px-8 shrink-0 z-50">
                <div class="flex items-center gap-10">
                    <div class="flex items-center gap-3">
                        <div id="dot-script" class="w-2 h-2 rounded-full bg-zinc-800 transition-all"></div>
                        <span class="text-[10px] font-black text-zinc-600 uppercase tracking-widest">Script</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <div id="dot-audio" class="w-2 h-2 rounded-full bg-zinc-800 transition-all"></div>
                        <span class="text-[10px] font-black text-zinc-600 uppercase tracking-widest">Voice</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <div id="dot-visuals" class="w-2 h-2 rounded-full bg-zinc-800 transition-all"></div>
                        <span class="text-[10px] font-black text-zinc-600 uppercase tracking-widest">Media</span>
                    </div>
                </div>
                <span class="hidden sm:block text-zinc-700 text-[10px] font-black uppercase tracking-[0.3em]">Client Build: 01.2026.5.5</span>
            </footer>
        </main>
    </div>

    <!-- TOAST -->
    <div id="toast" class="fixed bottom-24 right-10 transform translate-y-20 opacity-0 transition-all duration-500 z-[100] glass-panel px-8 py-5 rounded-2xl shadow-2xl pointer-events-none border-l-4 border-red-600">
        <p id="toast-msg" class="text-xs font-black text-white tracking-wide uppercase"></p>
    </div>

    <!-- MODAL -->
    <div id="dialog-modal" class="hidden fixed inset-0 z-[200] bg-black/90 backdrop-blur-md flex items-center justify-center p-6">
        <div class="glass-panel max-w-md w-full rounded-[3rem] p-10 text-center shadow-3xl border border-white/5">
            <h3 id="dialog-title" class="text-2xl font-black text-white uppercase italic mb-4">Notice</h3>
            <p id="dialog-body" class="text-sm text-zinc-500 font-medium mb-10 leading-relaxed px-4"></p>
            <div id="dialog-actions" class="flex gap-3">
                <button id="dialog-cancel" class="flex-1 py-4 bg-zinc-900 text-[11px] font-black uppercase tracking-widest text-zinc-400 rounded-2xl hover:bg-zinc-800 transition-colors">Abort</button>
                <button id="dialog-confirm" class="flex-1 py-4 bg-red-600 text-[11px] font-black uppercase tracking-widest text-white rounded-2xl hover:bg-red-700 transition-colors shadow-xl shadow-red-600/20">Proceed</button>
            </div>
        </div>
    </div>

    <script>
        const apiKey = ""; // API Context
        
        window.state = {
            apiKey: '',
            activeScriptTab: 'full',
            production: {
                topic: '',
                blueprint: null,
                audioUrl: null,
                visuals: [],
                images: [],
                timings: []
            },
            isPlaying: false,
            isRecording: false,
            currentIdx: -1
        };

        const masterAudio = new Audio();
        let audioCtx = null;
        let sourceNode = null;
        let mediaDest = null;
        const mainCanvas = document.getElementById('main-canvas');
        const mainCtx = mainCanvas.getContext('2d');

        function formatTimer(s) {
            const m = Math.floor(s/60), sec = Math.floor(s%60), ms = Math.floor((s%1)*100);
            return `${m.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}.${ms.toString().padStart(2,'0')}`;
        }

        window.showToast = (msg) => {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').textContent = msg;
            t.classList.remove('opacity-0', 'translate-y-20');
            t.classList.add('opacity-100', 'translate-y-0');
            setTimeout(() => {
                t.classList.add('opacity-0', 'translate-y-20');
            }, 3000);
        };

        window.customDialog = (title, body, confirmText = "Proceed") => {
            return new Promise((resolve) => {
                const m = document.getElementById('dialog-modal');
                document.getElementById('dialog-title').textContent = title;
                document.getElementById('dialog-body').textContent = body;
                document.getElementById('dialog-confirm').textContent = confirmText;
                m.classList.remove('hidden');
                const cleanup = (v) => { m.classList.add('hidden'); resolve(v); };
                document.getElementById('dialog-confirm').onclick = () => cleanup(true);
                document.getElementById('dialog-cancel').onclick = () => cleanup(false);
            });
        };

        async function apiCall(model, endpoint, payload, retries = 5) {
            const targetKey = window.state.apiKey || apiKey;
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:${endpoint}?key=${targetKey}`;
            
            for (let i = 0; i < retries; i++) {
                try {
                    const res = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (res.ok) return await res.json();
                    const err = await res.json();
                    if (res.status === 429 || res.status >= 500) {
                        await new Promise(r => setTimeout(r, Math.pow(2, i) * 1000));
                        continue;
                    }
                    throw new Error(err.error?.message || "Internal Node Error");
                } catch (e) {
                    if (i === retries - 1) throw e;
                }
            }
        }

        window.saveKey = async () => {
            const val = document.getElementById('api-key-input').value.trim();
            if (!val) return showToast("API Key Required");
            window.state.apiKey = val;
            
            try {
                await apiCall('gemini-2.5-flash-preview-09-2025', 'generateContent', {
                    contents: [{ parts: [{ text: "health_check" }] }]
                });
                document.getElementById('status-dot').className = "w-2 h-2 rounded-full bg-green-500 shadow-[0_0_15px_rgba(34,197,94,0.6)]";
                document.getElementById('status-text').textContent = "Secure Link Active";
                document.getElementById('status-text').className = "text-[10px] font-black text-green-500 uppercase tracking-widest";
                showToast("Node Link Verified");
            } catch (e) {
                showToast("Handshake Failed: Check Key");
            }
        };

        window.generateScript = async () => {
            if (!window.state.apiKey) return showToast("API Key Missing");
            const topic = document.getElementById('topic-input').value.trim();
            if(!topic) return showToast("Define Project Concept");
            
            const btn = document.getElementById('gen-script-btn');
            btn.disabled = true; btn.textContent = "Architecting Blueprint...";

            const prompt = `Return JSON only. Topic: "${topic}". 
            Structure: {"title": "Viral Hook Title", "full_text": "Complete Narration", "scenes": [{"narration": "one sentence", "prompt": "16:9 detailed photo prompt"}], "seo": {"tags": "#tag1 #tag2"}}. No text outside JSON.`;

            try {
                const data = await apiCall('gemini-2.5-flash-preview-09-2025', 'generateContent', {
                    contents: [{ parts: [{ text: topic }] }],
                    systemInstruction: { parts: [{ text: prompt }] },
                    generationConfig: { responseMimeType: "application/json" }
                });
                
                let raw = data.candidates[0].content.parts[0].text;
                try {
                    const blueprint = JSON.parse(raw.replace(/```json|```/gi, '').trim());
                    window.state.production.blueprint = blueprint;
                    window.state.production.topic = topic;
                    document.getElementById('dot-script').className = "w-2 h-2 rounded-full bg-green-500 shadow-[0_0_10px_rgba(34,197,94,0.4)]";
                    renderView();
                    showToast("Production Blueprint Constructed");
                } catch (err) {
                    showToast("Architect Error: Protocol Violation");
                }
            } catch (e) {
                showToast("System Failure: " + e.message);
            } finally {
                btn.disabled = false; btn.textContent = "Construct Blueprint";
            }
        };

        window.generateAudio = async () => {
            if (!audioCtx) initAudioSystem();

            if (!window.state.production.blueprint) return showToast("Blueprint Required");
            const btn = document.getElementById('gen-audio-btn');
            const loader = document.getElementById('voice-loader');
            const placeholder = document.getElementById('voice-placeholder');

            btn.disabled = true; loader.classList.remove('hidden'); placeholder.classList.add('hidden');

            try {
                let text = window.state.production.blueprint.scenes.map(s => s.narration).join(' ');
                const voice = document.getElementById('voice-name').value;
                const lang = document.getElementById('target-language').value.trim();

                // Incorporate language preference if provided
                if (lang) {
                    text = `Translate the following narration to ${lang} and speak it: ${text}`;
                }

                const data = await apiCall('gemini-2.5-flash-preview-tts', 'generateContent', {
                    contents: [{ parts: [{ text: text }] }],
                    generationConfig: {
                        responseModalities: ["AUDIO"],
                        speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: voice } } }
                    }
                });

                const base64 = data.candidates[0].content.parts.find(p => p.inlineData).inlineData.data;
                const binary = atob(base64);
                const bytes = new Uint8Array(binary.length);
                for(let i=0; i<binary.length; i++) bytes[i] = binary.charCodeAt(i);
                
                const blob = createWav(bytes, 24000);
                window.state.production.audioUrl = URL.createObjectURL(blob);
                masterAudio.src = window.state.production.audioUrl;

                masterAudio.onloadedmetadata = () => {
                    const dur = masterAudio.duration;
                    
                    // REFINED SYNC LOGIC (Natural Pause Weighted)
                    const weights = window.state.production.blueprint.scenes.map(s => {
                        let w = s.narration.length;
                        w += (s.narration.match(/,/g) || []).length * 40; // Comma weight
                        w += (s.narration.match(/[.!?]/g) || []).length * 80; // Full stop weight
                        return w;
                    });
                    
                    const totalWeight = weights.reduce((a, b) => a + b, 0);
                    let elapsed = 0;
                    window.state.production.timings = weights.map(w => {
                        const sceneDur = (w / totalWeight) * dur;
                        const t = { start: elapsed, end: elapsed + sceneDur };
                        elapsed += sceneDur; return t;
                    });
                    
                    document.getElementById('audio-duration-text').textContent = `00:00.00 / ${formatTimer(dur)}`;
                    document.getElementById('audio-container').classList.remove('hidden');
                    document.getElementById('dot-audio').className = "w-2 h-2 rounded-full bg-green-500 shadow-[0_0_10px_rgba(34,197,94,0.4)]";
                    renderView();
                    showToast("Narration Sync Complete");
                };
            } catch (e) {
                showToast("Synthesis Refused");
            } finally {
                btn.disabled = false; loader.classList.add('hidden');
            }
        };

        window.generateVisuals = async () => {
            if (!window.state.production.blueprint) return showToast("Blueprint Required");
            const btn = document.getElementById('gen-visuals-btn');
            const gallery = document.getElementById('asset-progress');
            btn.disabled = true; gallery.innerHTML = '';
            
            const scenes = window.state.production.blueprint.scenes;
            window.state.production.visuals.forEach(url => URL.revokeObjectURL(url));
            window.state.production.visuals = [];
            window.state.production.images = [];

            for (let i = 0; i < scenes.length; i++) {
                btn.textContent = `Forging Frame ${i+1}/${scenes.length}...`;
                const thumb = document.createElement('div');
                thumb.className = "asset-thumb loading";
                gallery.appendChild(thumb);

                try {
                    const data = await apiCall('imagen-4.0-generate-001', 'predict', {
                        instances: { prompt: `Cinematic 4k high-fidelity photo, award winning lighting: ${scenes[i].prompt}` },
                        parameters: { sampleCount: 1 }
                    });
                    
                    const b64 = data.predictions[0].bytesBase64Encoded;
                    const binary = atob(b64);
                    const bytes = new Uint8Array(binary.length);
                    for(let k=0; k<binary.length; k++) bytes[k] = binary.charCodeAt(k);
                    const blob = new Blob([bytes], {type: 'image/png'});
                    const url = URL.createObjectURL(blob);
                    
                    window.state.production.visuals[i] = url;
                    const img = new Image();
                    img.src = url;
                    await img.decode();
                    window.state.production.images[i] = img;

                    thumb.classList.remove('loading');
                    thumb.innerHTML = `<img src="${url}" class="w-full h-full object-cover">`;
                    if(i === 0) drawFrame(0);
                } catch (e) {
                    thumb.classList.remove('loading'); thumb.style.borderColor = "#991b1b";
                }
            }

            document.getElementById('dot-visuals').className = "w-2 h-2 rounded-full bg-green-500 shadow-[0_0_10px_rgba(34,197,94,0.4)]";
            btn.disabled = false; btn.textContent = "Generate Master Frames";
            document.getElementById('video-placeholder').classList.add('hidden');
            renderView();
            showToast("Visual Assets Sequenced");
        };

        function wrapText(ctx, text, x, y, maxWidth, lineHeight) {
            const words = text.split(' ');
            let line = '';
            let currentY = y;
            for(let n = 0; n < words.length; n++) {
                let testLine = line + words[n] + ' ';
                let metrics = ctx.measureText(testLine);
                if (metrics.width > maxWidth && n > 0) {
                    ctx.fillText(line, x, currentY);
                    line = words[n] + ' ';
                    currentY += lineHeight;
                } else { line = testLine; }
            }
            ctx.fillText(line, x, currentY);
        }

        function drawFrame(idx, text = "") {
            const img = window.state.production.images[idx];
            if (!img) return;
            mainCtx.fillStyle = "#000";
            mainCtx.fillRect(0, 0, 1280, 720);
            const ratio = Math.max(1280 / img.width, 720 / img.height);
            const w = img.width * ratio;
            const h = img.height * ratio;
            mainCtx.drawImage(img, (1280 - w) / 2, (720 - h) / 2, w, h);

            if (text) {
                mainCtx.save();
                mainCtx.shadowColor = "rgba(0,0,0,1)";
                mainCtx.shadowBlur = 20;
                mainCtx.fillStyle = "rgba(0,0,0,0.8)";
                const boxW = 1000, boxX = (1280 - boxW) / 2;
                mainCtx.beginPath();
                mainCtx.roundRect(boxX, 580, boxW, 110, 24);
                mainCtx.fill();
                mainCtx.fillStyle = "#ffffff";
                mainCtx.font = "800 32px 'Plus Jakarta Sans'";
                mainCtx.textAlign = "center";
                wrapText(mainCtx, text, 640, 632, 900, 42);
                mainCtx.restore();
            }
        }

        function initAudioSystem() {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            mediaDest = audioCtx.createMediaStreamDestination();
            sourceNode = audioCtx.createMediaElementSource(masterAudio);
            sourceNode.connect(mediaDest);
            sourceNode.connect(audioCtx.destination);
        }

        window.togglePlayback = () => {
            if (!window.state.production.audioUrl) return showToast("Buffer Empty: Synthesis Required");
            if (!audioCtx) initAudioSystem();

            if (window.state.isPlaying) {
                masterAudio.pause();
                window.state.isPlaying = false;
                syncUI(false);
            } else {
                masterAudio.currentTime = 0;
                masterAudio.play().then(() => {
                    window.state.isPlaying = true;
                    syncUI(true);
                    requestAnimationFrame(renderLoop);
                }).catch(() => showToast("Device Gesture Required for Playback"));
            }
        };

        function syncUI(playing) {
            const icons = [document.getElementById('play-icon'), document.getElementById('voice-play-icon')];
            icons.forEach(icon => {
                icon.innerHTML = playing ? `<path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>` : `<path d="M8 5v14l11-7z"/>`;
            });
            document.getElementById('voice-play-text').textContent = playing ? "Pause Synthesis" : "Preview Audio";
        }

        function renderLoop() {
            if (!window.state.isPlaying && !window.state.isRecording) return;
            const time = masterAudio.currentTime;
            document.getElementById('player-time').textContent = formatTimer(time);
            
            const timings = window.state.production.timings;
            let idx = timings.findIndex(t => time >= t.start && time < t.end);
            if (idx === -1 && time > 0) idx = timings.length - 1;

            if (idx !== -1) {
                // HIGHLIGHT ACTIVE SCENE IN UI
                if(window.state.currentIdx !== idx) {
                    window.state.currentIdx = idx;
                    const text = window.state.production.blueprint.scenes[idx].narration;
                    drawFrame(idx, text);
                    updateSceneHighlighter(idx);
                }
            }

            if (masterAudio.ended) {
                window.state.isPlaying = false;
                syncUI(false);
            } else {
                requestAnimationFrame(renderLoop);
            }
        }

        function updateSceneHighlighter(idx) {
            if(window.state.activeScriptTab !== 'scenes') return;
            const container = document.getElementById('script-viewport');
            const cards = container.querySelectorAll('div[data-scene]');
            cards.forEach((c, i) => {
                if(i === idx) c.classList.add('active-scene-card');
                else c.classList.remove('active-scene-card');
            });
        }

        window.exportMaster = async () => {
            if (window.state.isRecording) return;
            if (!window.state.production.images.length) return showToast("Frame Buffer Depleted");
            const ok = await customDialog("Encoder Activation", "A high-bitrate WebM master will be generated. This requires significant resources.", "Activate Encoder");
            if (!ok) return;
            if (!audioCtx) initAudioSystem();
            window.state.isRecording = true;
            const btn = document.getElementById('export-btn');
            btn.classList.add('recording-active');
            const stream = new MediaStream([...mainCanvas.captureStream(30).getVideoTracks(), ...mediaDest.stream.getAudioTracks()]);
            const mimeType = MediaRecorder.isTypeSupported('video/webm;codecs=vp9') ? 'video/webm;codecs=vp9' : (MediaRecorder.isTypeSupported('video/webm;codecs=vp8') ? 'video/webm;codecs=vp8' : 'video/webm');
            const recorder = new MediaRecorder(stream, { mimeType, videoBitsPerSecond: 8000000 });
            const chunks = [];
            recorder.ondataavailable = e => chunks.push(e.data);
            recorder.onstop = () => {
                const blob = new Blob(chunks, { type: 'video/webm' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `ProductionMaster_${Date.now()}.webm`; a.click();
                window.state.isRecording = false; btn.classList.remove('recording-active');
            };
            masterAudio.currentTime = 0; masterAudio.play(); recorder.start();
            const track = () => {
                if(!window.state.isRecording) return;
                renderLoop();
                if(masterAudio.ended) recorder.stop();
                else requestAnimationFrame(track);
            };
            track();
        };

        window.switchPage = (page) => {
            document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.sidebar-item').forEach(s => s.classList.remove('active'));
            document.getElementById(`view-${page}`).classList.add('active');
            document.getElementById(`nav-${page}`).classList.add('active');
            renderView();
        };

        window.renderView = () => {
            const p = window.state.production;
            document.getElementById('dash-topic').textContent = p.topic || 'Awaiting Project';
            const scriptStatus = document.getElementById('dash-script-status');
            const voiceStatus = document.getElementById('dash-audio-status');
            const mediaStatus = document.getElementById('dash-video-status');

            if (p.blueprint) {
                scriptStatus.textContent = "Synthesized";
                scriptStatus.classList.add('text-red-600');
                document.getElementById('stats-panel').classList.remove('hidden');
                document.getElementById('stat-words').textContent = p.blueprint.full_text.split(' ').length;
                document.getElementById('stat-duration').textContent = formatTimer(masterAudio.duration || 0);
                document.getElementById('seo-title').textContent = p.blueprint.title;
                document.getElementById('seo-tags').textContent = p.blueprint.seo?.tags || "None";
                
                const vp = document.getElementById('script-viewport');
                vp.classList.remove('italic');
                if (window.state.activeScriptTab === 'full') {
                    vp.textContent = p.blueprint.full_text;
                } else {
                    vp.innerHTML = p.blueprint.scenes.map((s, i) => `<div data-scene="${i}" class='p-5 glass-panel rounded-2xl mb-3 text-xs border border-white/5 transition-all'>${s.narration}</div>`).join('');
                }
            } else { scriptStatus.textContent = "Pending"; scriptStatus.classList.remove('text-red-600'); }

            if (p.audioUrl) { voiceStatus.textContent = "Ready"; voiceStatus.classList.add('text-red-600'); }
            else { voiceStatus.textContent = "Waiting"; voiceStatus.classList.remove('text-red-600'); }

            if (p.visuals.length > 0) { mediaStatus.textContent = "Encoded"; mediaStatus.classList.add('text-red-600'); }
            else { mediaStatus.textContent = "Idle"; mediaStatus.classList.remove('text-red-600'); }
        };

        window.switchScriptTab = (t) => { window.state.activeScriptTab = t; renderView(); };

        window.confirmReset = async () => {
            const ok = await customDialog("Memory Purge", "Proceed with system-wide memory wipe? All assets will be volatile.", "Hard Reset");
            if(ok) { 
                window.state.production.visuals.forEach(url => URL.revokeObjectURL(url));
                sessionStorage.clear(); location.reload(); 
            }
        };

        function createWav(pcm, rate) {
            const h = new ArrayBuffer(44), v = new DataView(h);
            const s = (o, str) => { for(let i=0; i<str.length; i++) v.setUint8(o+i, str.charCodeAt(i)); };
            s(0, 'RIFF'); v.setUint32(4, 36 + pcm.length, true); s(8, 'WAVE'); s(12, 'fmt ');
            v.setUint32(16, 16, true); v.setUint16(20, 1, true); v.setUint16(22, 1, true);
            v.setUint32(24, rate, true); v.setUint32(28, rate * 2, true); v.setUint16(32, 2, true); v.setUint16(34, 16, true);
            s(36, 'data'); v.setUint32(40, pcm.length, true); return new Blob([h, pcm], { type: 'audio/wav' });
        }
    </script>
</body>
</html>