<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoTube Studio | End-to-End Video Production</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-base: #09090b;
            --bg-surface: #121217;
            --bg-card: #18181b;
            --brand-red: #ef4444;
            --border-muted: #27272a;
            --text-main: #fafafa;
            --text-muted: #a1a1aa;
        }

        body {
            background-color: var(--bg-base);
            color: var(--text-main);
            font-family: 'Plus Jakarta Sans', sans-serif;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 10px; }

        .glass-panel {
            background: rgba(18, 18, 23, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid var(--border-muted);
        }

        .sidebar-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 16px;
            border-radius: 8px;
            color: var(--text-muted);
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }

        /* Responsive Sidebar Adjustments */
        @media (max-width: 768px) {
            .sidebar-item {
                flex-direction: column;
                gap: 4px;
                padding: 8px;
                font-size: 0.7rem;
                flex: 1;
                justify-content: center;
                border-radius: 0;
            }
            .sidebar-item svg { width: 1.25rem; height: 1.25rem; }
        }

        .sidebar-item:hover {
            background: rgba(255, 255, 255, 0.05);
            color: white;
        }

        .sidebar-item.active {
            background: rgba(239, 68, 68, 0.1);
            color: var(--brand-red);
        }

        .input-field {
            background: #1c1c21 !important;
            border: 1px solid var(--border-muted) !important;
            color: white !important;
            transition: all 0.2s;
        }

        .input-field:focus {
            border-color: var(--brand-red) !important;
            box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.1);
            outline: none;
        }

        .tab-trigger {
            position: relative;
            padding: 12px 16px;
            font-size: 0.8125rem;
            font-weight: 600;
            color: var(--text-muted);
            cursor: pointer;
            transition: color 0.2s;
            white-space: nowrap;
        }

        .tab-trigger.active { color: white; }
        .tab-trigger.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--brand-red);
        }

        .pulse-green { animation: pulse-green 2s infinite; }
        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4); }
            70% { box-shadow: 0 0 0 8px rgba(34, 197, 94, 0); }
            100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
        }

        .view-section { 
            display: none; 
            height: 100%;
            overflow-y: auto;
        }
        .view-section.active { display: block; animation: fadeIn 0.3s ease-out; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(4px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .video-container {
            aspect-ratio: 16/9;
            background: black;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            width: 100%;
        }

        .video-overlay {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
            padding: 10px;
            border-radius: 8px;
            color: white;
            font-size: 0.875rem;
            text-align: center;
        }
    </style>
</head>
<body class="flex flex-col">

    <!-- TOP HEADER -->
    <header class="h-14 border-b border-[#27272a] bg-black flex items-center justify-between px-4 md:px-6 shrink-0 z-50">
        <div class="flex items-center gap-3 md:gap-4">
            <div class="flex items-center gap-2">
                <div class="w-7 h-7 bg-red-600 rounded flex items-center justify-center font-black text-white italic text-xs">AT</div>
                <span class="font-bold tracking-tight text-xs md:text-sm">AutoTube Studio</span>
            </div>
            <div class="hidden sm:block h-4 w-px bg-zinc-800"></div>
            <span class="hidden sm:block text-[9px] text-zinc-500 font-bold uppercase tracking-widest">v3.5 Final</span>
        </div>
        
        <div id="connection-status" class="flex items-center gap-2 px-2 md:px-3 py-1 rounded-full border border-zinc-800 bg-zinc-900/50">
            <div id="status-dot" class="w-1.5 h-1.5 md:w-2 md:h-2 rounded-full bg-zinc-600"></div>
            <span id="status-text" class="text-[9px] md:text-[10px] font-extrabold uppercase tracking-wider text-zinc-500">API Status</span>
        </div>
    </header>

    <div class="flex flex-col md:flex-row flex-1 overflow-hidden">
        <!-- NAVIGATION SIDEBAR / BOTTOM NAV -->
        <aside class="w-full md:w-60 border-t md:border-t-0 md:border-r border-[#27272a] p-0 md:p-4 flex md:flex-col shrink-0 bg-[#0c0c0e] order-last md:order-first z-50">
            <nav class="flex flex-row md:flex-col flex-1" id="sidebar-nav">
                <div class="sidebar-item active" data-page="dashboard"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg> <span>Dash</span></div>
                <div class="sidebar-item" data-page="script"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg> <span>Script</span></div>
                <div class="sidebar-item" data-page="voice"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path></svg> <span>Voice</span></div>
                <div class="sidebar-item" data-page="video"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg> <span>Video</span></div>
                <div class="sidebar-item" data-page="seo"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg> <span>SEO</span></div>
            </nav>
            <div class="hidden md:flex mt-auto pt-6 border-t border-zinc-800">
                <div class="sidebar-item w-full" data-page="settings"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924-1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37a1.724 1.724 0 002.572-1.065z"></path></svg> Settings</div>
            </div>
        </aside>

        <!-- MAIN WORKSPACE -->
        <main class="flex-1 bg-[#09090b] relative overflow-hidden flex flex-col">
            
            <div class="flex-1 overflow-y-auto custom-scrollbar" id="main-scroll-container">
                <!-- SECTION: DASHBOARD -->
                <section id="view-dashboard" class="view-section active p-4 md:p-8">
                    <div class="max-w-7xl mx-auto">
                        <h2 class="text-2xl md:text-3xl font-extrabold tracking-tight mb-2">Dashboard</h2>
                        <p class="text-zinc-500 text-sm mb-6 md:mb-8">Overview of your current production pipeline.</p>
                        
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6">
                            <div class="glass-panel p-5 rounded-2xl">
                                <span class="text-[10px] font-black uppercase tracking-[0.2em] text-zinc-500">Project Status</span>
                                <h4 class="text-lg md:text-xl font-bold mt-2 truncate" id="dash-project-name">No active project</h4>
                                <div class="w-full bg-zinc-800 h-2 rounded-full mt-4 overflow-hidden">
                                    <div id="dash-progress" class="bg-red-600 h-full transition-all duration-500" style="width: 0%"></div>
                                </div>
                            </div>
                            <div class="glass-panel p-5 rounded-2xl">
                                <span class="text-[10px] font-black uppercase tracking-[0.2em] text-zinc-500">Audio Preview</span>
                                <h4 class="text-lg md:text-xl font-bold mt-2" id="dash-audio-status">None Generated</h4>
                            </div>
                            <div class="glass-panel p-5 rounded-2xl">
                                <span class="text-[10px] font-black uppercase tracking-[0.2em] text-zinc-500">Video Finalized</span>
                                <h4 class="text-lg md:text-xl font-bold mt-2" id="dash-video-status">Pending</h4>
                            </div>
                        </div>

                        <div class="mt-8 glass-panel rounded-2xl p-6 md:p-12 border-dashed border-zinc-800 text-center">
                            <p class="text-zinc-500 text-sm mb-6">Ready to start a new production?</p>
                            <button class="w-full sm:w-auto px-10 py-4 bg-red-600 rounded-xl font-bold hover:bg-red-700 transition-all nav-trigger" data-page="script">Enter Script Engine</button>
                        </div>
                    </div>
                </section>

                <!-- SECTION: SCRIPT ENGINE -->
                <section id="view-script" class="view-section p-4 md:p-8">
                    <div class="max-w-7xl mx-auto">
                        <h2 class="text-2xl md:text-3xl font-extrabold tracking-tight mb-2">Script Engine</h2>
                        <p class="text-zinc-500 text-sm mb-6 md:mb-8">Define your topic and let Gemini generate the narrative.</p>

                        <div class="mb-6 md:mb-8 p-5 glass-panel rounded-xl flex flex-col lg:flex-row lg:items-center gap-6 border-zinc-800/50">
                            <div class="flex-1">
                                <h4 class="text-xs font-bold uppercase tracking-wider text-zinc-400 mb-1">Gemini AI Key</h4>
                                <p class="text-[11px] text-zinc-500">Required for generating production assets.</p>
                            </div>
                            <div class="flex flex-col sm:flex-row gap-2 w-full lg:w-auto lg:min-w-[400px]">
                                <input type="password" id="api-key-input" placeholder="Paste Gemini Key..." class="flex-1 input-field px-4 py-2 rounded-lg text-sm">
                                <button id="save-key-btn" class="px-5 py-2 bg-white text-black text-xs font-bold rounded-lg hover:bg-zinc-200">Connect</button>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 md:gap-8 mb-8">
                            <div class="lg:col-span-5">
                                <div class="glass-panel p-5 md:p-6 rounded-2xl border-zinc-800/60 h-full">
                                    <div class="flex flex-col h-full gap-6">
                                        <div class="flex-1">
                                            <label class="block text-[11px] font-bold text-zinc-500 uppercase tracking-widest mb-3">Topic / Premise</label>
                                            <textarea id="topic-input" class="input-field w-full px-4 py-3 rounded-xl text-sm leading-relaxed resize-none h-40 md:h-64" placeholder="Explain the concept of quantum computing for beginners..."></textarea>
                                        </div>
                                        <button id="generate-btn" class="w-full py-4 bg-red-600 hover:bg-red-700 text-white font-extrabold rounded-xl shadow-xl transition-all">
                                            Generate Production Pack
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="lg:col-span-7">
                                <div class="glass-panel flex flex-col min-h-[400px] lg:h-full max-h-[600px] rounded-2xl overflow-hidden">
                                    <div class="flex border-b border-zinc-800 bg-zinc-900/30 overflow-x-auto shrink-0 no-scrollbar" id="output-tabs">
                                        <div class="tab-trigger active" data-tab="script">Full Script</div>
                                        <div class="tab-trigger" data-tab="hooks">Opening Hooks</div>
                                        <div class="tab-trigger" data-tab="scenes">Scene Briefs</div>
                                    </div>
                                    <div class="flex-1 overflow-y-auto p-4 md:p-6 bg-black/20 custom-scrollbar" id="script-output-container">
                                        <div id="empty-script" class="h-full flex flex-col items-center justify-center text-zinc-600 text-center">
                                            <p class="text-sm">Generate script to begin production</p>
                                        </div>
                                        <div id="script-content" class="hidden whitespace-pre-wrap text-sm leading-relaxed text-zinc-300 font-medium"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- SECTION: AI VOICEOVER -->
                <section id="view-voice" class="view-section p-4 md:p-8">
                    <div class="max-w-7xl mx-auto">
                        <h2 class="text-2xl md:text-3xl font-extrabold tracking-tight mb-2">AI Voiceover</h2>
                        <p class="text-zinc-500 text-sm mb-6 md:mb-8">Convert your generated script into narration.</p>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 md:gap-8">
                            <div class="glass-panel p-5 md:p-6 rounded-2xl">
                                <h4 class="text-xs font-bold text-zinc-500 uppercase tracking-widest mb-6">Voice Persona</h4>
                                <div class="space-y-6">
                                    <div>
                                        <label class="block text-[10px] text-zinc-400 mb-2 font-bold uppercase">Select Voice</label>
                                        <select id="voice-name-select" class="input-field w-full px-4 py-3 rounded-lg text-sm">
                                            <option value="Kore">Kore (Trustworthy)</option>
                                            <option value="Zephyr">Zephyr (Friendly)</option>
                                            <option value="Charon">Charon (Authoritative)</option>
                                            <option value="Puck">Puck (Energetic)</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-[10px] text-zinc-400 mb-2 font-bold uppercase">Tone Style</label>
                                        <select id="voice-pacing-select" class="input-field w-full px-4 py-3 rounded-lg text-sm">
                                            <option value="professional">Professional & Balanced</option>
                                            <option value="excited">Excited & Fast</option>
                                            <option value="calm">Calm & Educational</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="glass-panel p-5 md:p-6 rounded-2xl flex flex-col min-h-[300px]">
                                <h4 class="text-xs font-bold text-red-500 uppercase tracking-widest mb-4">Ready to Synthesize</h4>
                                <div id="voice-script-preview" class="flex-1 text-sm text-zinc-400 italic mb-6 line-clamp-6 bg-black/20 p-4 rounded-xl custom-scrollbar overflow-y-auto">
                                    Generate script first.
                                </div>
                                <div class="space-y-4">
                                    <button id="generate-audio-btn" class="w-full py-4 bg-red-600 text-white font-bold rounded-xl text-sm hover:bg-red-700 transition-all disabled:opacity-50">Generate Narration</button>
                                    <div id="audio-player-container" class="hidden flex items-center justify-center p-2 bg-zinc-900 rounded-xl border border-zinc-800">
                                        <audio id="tts-audio-player" controls class="w-full h-8"></audio>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- SECTION: VIDEO PRODUCTION -->
                <section id="view-video" class="view-section p-4 md:p-8">
                    <div class="max-w-7xl mx-auto">
                        <h2 class="text-2xl md:text-3xl font-extrabold tracking-tight mb-2">Video Production</h2>
                        <p class="text-zinc-500 text-sm mb-6 md:mb-8">Generate cinematic visuals and preview your composite.</p>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 md:gap-8">
                            <div class="lg:col-span-8">
                                <div class="video-container shadow-2xl border border-zinc-800" id="video-preview-wrapper">
                                    <div id="video-placeholder" class="absolute inset-0 flex flex-col items-center justify-center bg-zinc-900 text-zinc-600 p-6 text-center">
                                        <svg class="w-10 h-10 mb-3 opacity-20" fill="currentColor" viewBox="0 0 20 20"><path d="M2 6a2 2 0 012-2h12a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM14.553 7.106A1 1 0 0014 8v4a1 1 0 00.553.894l2 1A1 1 0 0018 13V7a1 1 0 00-1.447-.894l-2 1z"></path></svg>
                                        <p class="text-[10px] font-bold uppercase tracking-widest opacity-50">Visual Content Pending</p>
                                    </div>
                                    <img id="video-bg-layer" class="hidden w-full h-full object-cover" src="" alt="Background">
                                    <div id="subtitle-layer" class="hidden video-overlay">Subtitle preview...</div>
                                </div>
                                
                                <button id="play-composite-btn" class="w-full mt-6 py-4 bg-white text-black font-black rounded-xl text-sm flex items-center justify-center gap-2 hover:bg-zinc-200 transition-all disabled:opacity-30">
                                    Preview Final Production
                                </button>
                            </div>

                            <div class="lg:col-span-4 space-y-4 md:space-y-6">
                                <div class="glass-panel p-5 md:p-6 rounded-2xl">
                                    <h4 class="text-xs font-bold text-zinc-500 uppercase tracking-widest mb-4">Background Visual</h4>
                                    <button id="generate-vid-bg-btn" class="w-full py-4 bg-zinc-800 border border-zinc-700 text-white rounded-xl text-xs font-bold hover:bg-zinc-700 disabled:opacity-50">
                                        Generate Cinematic AI Asset
                                    </button>
                                </div>
                                <div class="glass-panel p-5 md:p-6 rounded-2xl">
                                    <h4 class="text-xs font-bold text-zinc-500 uppercase tracking-widest mb-4">Production Status</h4>
                                    <ul class="text-[10px] space-y-3 text-zinc-400 font-bold uppercase tracking-wider">
                                        <li class="flex items-center gap-2" id="comp-voice-status"><div class="w-1.5 h-1.5 rounded-full bg-zinc-700"></div> Audio Pending</li>
                                        <li class="flex items-center gap-2" id="comp-bg-status"><div class="w-1.5 h-1.5 rounded-full bg-zinc-700"></div> Visual Missing</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- SECTION: SEO -->
                <section id="view-seo" class="view-section p-4 md:p-8">
                    <div class="max-w-7xl mx-auto">
                        <h2 class="text-2xl md:text-3xl font-extrabold tracking-tight mb-2">SEO Optimizer</h2>
                        <p class="text-zinc-500 text-sm mb-6 md:mb-8">Metadata for algorithm optimization.</p>
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6" id="seo-container">
                            <div class="lg:col-span-3 glass-panel p-12 text-center text-zinc-600 rounded-2xl">
                                <p>Finish your script and production to see SEO suggestions.</p>
                            </div>
                        </div>
                    </div>
                </section>
            </div>

            <!-- FOOTER TOOLBAR -->
            <footer class="h-auto md:h-20 bg-zinc-950 border-t border-zinc-800 flex flex-col md:flex-row items-center justify-between px-6 py-4 md:py-0 shrink-0 z-50 gap-4">
                <div class="flex items-center w-full md:w-auto">
                    <div class="flex flex-col">
                        <span class="text-[9px] font-black text-zinc-600 uppercase tracking-widest mb-1">Active Project</span>
                        <span class="text-xs font-bold text-zinc-300 truncate max-w-[200px]" id="global-project-name">Untitled Production</span>
                    </div>
                </div>

                <div class="flex gap-2 w-full md:w-auto">
                    <button id="reset-all-btn" class="flex-1 md:flex-none px-4 py-2 text-zinc-500 hover:text-white text-[10px] font-black uppercase tracking-wider">Reset</button>
                    <button id="next-step-btn" class="flex-1 md:flex-none px-8 py-3 bg-white hover:bg-zinc-200 text-black text-[10px] font-black uppercase tracking-widest rounded-xl transition-all">Next Phase</button>
                </div>
            </footer>
        </main>
    </div>

    <!-- TOAST -->
    <div id="toast" class="fixed bottom-24 right-4 md:right-8 transform translate-y-20 opacity-0 transition-all duration-300 z-[100] bg-zinc-900 border border-zinc-800 px-6 py-4 rounded-xl shadow-2xl pointer-events-none">
        <p id="toast-msg" class="text-xs text-zinc-300 font-bold text-center md:text-left"></p>
    </div>

    <script>
        const API_MODEL = "gemini-2.5-flash-preview-09-2025";
        const TTS_MODEL = "gemini-2.5-flash-preview-tts";
        const IMAGEN_MODEL = "imagen-4.0-generate-001";
        
        let state = {
            activePage: 'dashboard',
            apiKey: '',
            config: { topic: '' },
            outputs: {
                script: '',
                hooks: '',
                scenes: [],
                seo: null,
                audioBlobUrl: null,
                videoBackgroundB64: null
            },
            activeTab: 'script'
        };

        const PAGES = ['dashboard', 'script', 'voice', 'video', 'seo', 'settings'];

        const DOM = {
            sidebarItems: document.querySelectorAll('.sidebar-item'),
            viewSections: document.querySelectorAll('.view-section'),
            apiKeyInput: document.getElementById('api-key-input'),
            saveKeyBtn: document.getElementById('save-key-btn'),
            statusDot: document.getElementById('status-dot'),
            statusText: document.getElementById('status-text'),
            topicInput: document.getElementById('topic-input'),
            generateBtn: document.getElementById('generate-btn'),
            scriptContent: document.getElementById('script-content'),
            emptyScript: document.getElementById('empty-script'),
            nextStepBtn: document.getElementById('next-step-btn'),
            seoContainer: document.getElementById('seo-container'),
            dashProjectName: document.getElementById('dash-project-name'),
            dashProgress: document.getElementById('dash-progress'),
            dashAudioStatus: document.getElementById('dash-audio-status'),
            dashVideoStatus: document.getElementById('dash-video-status'),
            globalProjectName: document.getElementById('global-project-name'),
            voicePreview: document.getElementById('voice-script-preview'),
            resetBtn: document.getElementById('reset-all-btn'),
            generateAudioBtn: document.getElementById('generate-audio-btn'),
            audioPlayer: document.getElementById('tts-audio-player'),
            audioContainer: document.getElementById('audio-player-container'),
            voiceNameSelect: document.getElementById('voice-name-select'),
            voicePacingSelect: document.getElementById('voice-pacing-select'),
            videoPlaceholder: document.getElementById('video-placeholder'),
            videoBgLayer: document.getElementById('video-bg-layer'),
            subtitleLayer: document.getElementById('subtitle-layer'),
            playCompositeBtn: document.getElementById('play-composite-btn'),
            generateVidBgBtn: document.getElementById('generate-vid-bg-btn'),
            compVoiceStatus: document.getElementById('comp-voice-status'),
            compBgStatus: document.getElementById('comp-bg-status'),
            toast: document.getElementById('toast')
        };

        window.addEventListener('DOMContentLoaded', () => {
            loadState();
            attachListeners();
            checkConnection();
            renderView();
        });

        function loadState() {
            const saved = localStorage.getItem('autotube_v4_state');
            if (saved) {
                state = { ...state, ...JSON.parse(saved) };
                DOM.apiKeyInput.value = state.apiKey;
                DOM.topicInput.value = state.config.topic;
            }
        }

        function saveState() {
            localStorage.setItem('autotube_v4_state', JSON.stringify(state));
            updateDashboard();
        }

        function renderView() {
            DOM.sidebarItems.forEach(item => item.classList.toggle('active', item.dataset.page === state.activePage));
            DOM.viewSections.forEach(section => section.classList.toggle('active', section.id === `view-${state.activePage}`));

            const currentIndex = PAGES.indexOf(state.activePage);
            if (currentIndex < PAGES.length - 2) { 
                const next = PAGES[currentIndex + 1];
                DOM.nextStepBtn.textContent = `Next: ${next.toUpperCase()}`;
                DOM.nextStepBtn.classList.remove('hidden');
            } else {
                DOM.nextStepBtn.classList.add('hidden');
            }

            if (state.activePage === 'seo') renderSEO();
            if (state.activePage === 'voice') {
                DOM.voicePreview.textContent = state.outputs.script || "Please generate a script first.";
                DOM.generateAudioBtn.disabled = !state.outputs.script;
                if (state.outputs.audioBlobUrl) {
                    DOM.audioContainer.classList.remove('hidden');
                    DOM.audioPlayer.src = state.outputs.audioBlobUrl;
                }
            }
            if (state.activePage === 'script') renderScriptOutput();
            if (state.activePage === 'video') renderVideoSection();
            
            updateDashboard();
        }

        function updateDashboard() {
            const hasScript = !!state.outputs.script;
            const hasAudio = !!state.outputs.audioBlobUrl;
            const hasVideo = !!state.outputs.videoBackgroundB64;
            
            DOM.dashProjectName.textContent = state.config.topic || 'No active project';
            DOM.globalProjectName.textContent = state.config.topic || 'Untitled Production';
            DOM.dashAudioStatus.textContent = hasAudio ? 'Ready' : 'Pending';
            DOM.dashVideoStatus.textContent = hasVideo ? 'Ready' : 'Pending';
            
            let progress = 0;
            if (hasScript) progress += 25;
            if (hasAudio) progress += 25;
            if (hasVideo) progress += 25;
            if (state.outputs.seo) progress += 25;
            DOM.dashProgress.style.width = `${progress}%`;
        }

        async function checkConnection() {
            if (!state.apiKey) return updateStatusUI('disconnected');
            updateStatusUI('checking');
            try {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/${API_MODEL}:generateContent?key=${state.apiKey}`;
                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: "ping" }] }] })
                });
                updateStatusUI(res.ok ? 'connected' : 'error');
            } catch (e) { updateStatusUI('error'); }
        }

        function updateStatusUI(status) {
            DOM.statusDot.className = `w-2 h-2 rounded-full ${status === 'connected' ? 'bg-green-500 pulse-green' : status === 'error' ? 'bg-red-500' : 'bg-zinc-600'}`;
            DOM.statusText.textContent = status === 'connected' ? 'Connected' : status === 'error' ? 'Auth Error' : 'Offline';
            DOM.statusText.className = `text-[10px] font-extrabold uppercase tracking-wider ${status === 'connected' ? 'text-green-500' : 'text-zinc-500'}`;
        }

        async function generateWorkflow() {
            if (!state.apiKey) return showToast("API Key Required");
            if (!state.config.topic.trim()) return showToast("Enter a Topic");

            DOM.generateBtn.disabled = true;
            DOM.generateBtn.textContent = "Writing Production Pack...";
            
            const prompt = `YOUTUBE STRATEGIST MODE. Topic: ${state.config.topic}. Return JSON: {"script": "narration", "hooks": "opening hooks", "scenes": [{"title": "Brief", "prompt": "Visual prompt"}], "seo": {"titles": ["T1"], "description": "Box", "tags": "t1,t2"}}`;

            try {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/${API_MODEL}:generateContent?key=${state.apiKey}`;
                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await res.json();
                const jsonText = data.candidates[0].content.parts[0].text.replace(/```json|```/gi, '').trim();
                const parsed = JSON.parse(jsonText);
                state.outputs.script = parsed.script;
                state.outputs.hooks = parsed.hooks;
                state.outputs.scenes = parsed.scenes || [];
                state.outputs.seo = parsed.seo;
                saveState();
                renderView();
                showToast("Production Pack Ready!");
            } catch (e) { showToast("Generation Failed"); }
            finally { 
                DOM.generateBtn.disabled = false;
                DOM.generateBtn.textContent = "Generate Production Pack";
            }
        }

        async function generateAudio() {
            if (!state.outputs.script) return;
            DOM.generateAudioBtn.disabled = true;
            DOM.generateAudioBtn.textContent = "Synthesizing...";
            
            const voice = DOM.voiceNameSelect.value;
            const pacing = DOM.voicePacingSelect.value;
            const text = `Narration tone: ${pacing}. Script: ${state.outputs.script.substring(0, 3000)}`;

            try {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/${TTS_MODEL}:generateContent?key=${state.apiKey}`;
                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text }] }],
                        generationConfig: {
                            responseModalities: ["AUDIO"],
                            speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: voice } } }
                        }
                    })
                });
                const data = await res.json();
                const pcmData = data.candidates[0].content.parts[0].inlineData.data;
                const mimeType = data.candidates[0].content.parts[0].inlineData.mimeType;
                const sampleRate = mimeType.match(/rate=(\d+)/) ? parseInt(mimeType.match(/rate=(\d+)/)[1]) : 24000;
                
                state.outputs.audioBlobUrl = pcmToWav(pcmData, sampleRate);
                DOM.audioPlayer.src = state.outputs.audioBlobUrl;
                DOM.audioContainer.classList.remove('hidden');
                saveState();
                showToast("Narration Synthesized!");
            } catch (e) { showToast("Synthesis Error"); }
            finally { 
                DOM.generateAudioBtn.disabled = false;
                DOM.generateAudioBtn.textContent = "Regenerate Narration";
            }
        }

        function pcmToWav(base64Pcm, sampleRate) {
            const binaryString = window.atob(base64Pcm);
            const bytes = new Uint8Array(binaryString.length);
            for (let i = 0; i < binaryString.length; i++) bytes[i] = binaryString.charCodeAt(i);
            const wavHeader = new ArrayBuffer(44);
            const view = new DataView(wavHeader);
            const writeStr = (v, o, s) => { for (let i = 0; i < s.length; i++) v.setUint8(o + i, s.charCodeAt(i)); };
            writeStr(view, 0, 'RIFF');
            view.setUint32(4, 36 + bytes.length, true);
            writeStr(view, 8, 'WAVE');
            writeStr(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true); 
            view.setUint16(22, 1, true); 
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true);
            view.setUint16(32, 2, true);
            view.setUint16(34, 16, true);
            writeStr(view, 36, 'data');
            view.setUint32(40, bytes.length, true);
            return URL.createObjectURL(new Blob([wavHeader, bytes], { type: 'audio/wav' }));
        }

        async function generateVideoBackground() {
            if (!state.outputs.script) return showToast("Generate script first");
            DOM.generateVidBgBtn.disabled = true;
            DOM.generateVidBgBtn.textContent = "AI Painting Scene...";

            const prompt = `Cinematic YouTube background: ${state.config.topic}. Highly professional, 4k detail.`;

            try {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/${IMAGEN_MODEL}:predict?key=${state.apiKey}`;
                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ instances: { prompt }, parameters: { sampleCount: 1 } })
                });
                const data = await res.json();
                state.outputs.videoBackgroundB64 = `data:image/png;base64,${data.predictions[0].bytesBase64Encoded}`;
                saveState();
                renderVideoSection();
                showToast("Visual Asset Created!");
            } catch (e) { showToast("Visual Gen Failed"); }
            finally { 
                DOM.generateVidBgBtn.disabled = false;
                DOM.generateVidBgBtn.textContent = "Regenerate Visual";
            }
        }

        function renderVideoSection() {
            const hasBg = !!state.outputs.videoBackgroundB64;
            const hasAudio = !!state.outputs.audioBlobUrl;
            
            if (hasBg) {
                DOM.videoPlaceholder.classList.add('hidden');
                DOM.videoBgLayer.src = state.outputs.videoBackgroundB64;
                DOM.videoBgLayer.classList.remove('hidden');
                DOM.compBgStatus.innerHTML = '<div class="w-1.5 h-1.5 rounded-full bg-green-500"></div> Visual Ready';
            }
            if (hasAudio) {
                DOM.compVoiceStatus.innerHTML = '<div class="w-1.5 h-1.5 rounded-full bg-green-500"></div> Audio Integrated';
            }
            DOM.playCompositeBtn.disabled = !(hasBg && hasAudio);
        }

        function playComposite() {
            if (!state.outputs.audioBlobUrl) return;
            const player = new Audio(state.outputs.audioBlobUrl);
            DOM.subtitleLayer.classList.remove('hidden');
            DOM.subtitleLayer.textContent = "Production Preview Initializing...";
            
            const lines = state.outputs.script.split('.');
            let i = 0;
            const subInterval = setInterval(() => {
                if (i < lines.length && !player.paused) {
                    DOM.subtitleLayer.textContent = lines[i].trim();
                    i++;
                } else clearInterval(subInterval);
            }, 3000);

            player.play();
            player.onended = () => DOM.subtitleLayer.classList.add('hidden');
        }

        function renderScriptOutput() {
            const hasContent = !!state.outputs.script;
            DOM.emptyScript.classList.toggle('hidden', hasContent);
            DOM.scriptContent.classList.toggle('hidden', !hasContent);
            if (hasContent) {
                const val = state.outputs[state.activeTab];
                DOM.scriptContent.textContent = typeof val === 'string' ? val : JSON.stringify(val, null, 2);
            }
        }

        function renderSEO() {
            if (!state.outputs.seo) return;
            const s = state.outputs.seo;
            DOM.seoContainer.innerHTML = `
                <div class="lg:col-span-2 glass-panel p-6 rounded-2xl space-y-4">
                    <h5 class="text-[9px] font-black text-zinc-500 uppercase tracking-widest">Optimized Titles</h5>
                    ${s.titles.map(t => `<div class="p-4 bg-zinc-900 rounded-xl text-sm border border-zinc-800 text-zinc-300 font-bold">${t}</div>`).join('')}
                </div>
                <div class="glass-panel p-6 rounded-2xl">
                     <h5 class="text-[9px] font-black text-zinc-500 uppercase tracking-widest mb-4">Meta Tags</h5>
                     <div class="flex flex-wrap gap-2">${s.tags.split(',').map(tag => `<span class="px-3 py-1 bg-zinc-800 rounded-lg text-xs text-zinc-400 border border-zinc-700">#${tag.trim()}</span>`).join('')}</div>
                </div>
                <div class="lg:col-span-3 glass-panel p-6 rounded-2xl">
                    <h5 class="text-[9px] font-black text-zinc-500 uppercase tracking-widest mb-4">Description Template</h5>
                    <div class="p-4 bg-zinc-900 rounded-xl text-[11px] leading-relaxed text-zinc-400 border border-zinc-800 whitespace-pre-wrap font-mono max-h-40 overflow-y-auto">${s.description}</div>
                </div>
            `;
        }

        function showToast(msg) {
            document.getElementById('toast-msg').textContent = msg;
            DOM.toast.classList.replace('opacity-0', 'opacity-100');
            DOM.toast.classList.replace('translate-y-20', 'translate-y-0');
            setTimeout(() => {
                DOM.toast.classList.replace('opacity-100', 'opacity-0');
                DOM.toast.classList.replace('translate-y-0', 'translate-y-20');
            }, 3000);
        }

        function attachListeners() {
            document.querySelectorAll('.sidebar-item[data-page], .nav-trigger').forEach(el => {
                el.onclick = () => { state.activePage = el.dataset.page; renderView(); };
            });

            DOM.nextStepBtn.onclick = () => {
                const currentIndex = PAGES.indexOf(state.activePage);
                if (currentIndex < PAGES.length - 1) { state.activePage = PAGES[currentIndex + 1]; renderView(); }
            };

            DOM.saveKeyBtn.onclick = () => { state.apiKey = DOM.apiKeyInput.value.trim(); saveState(); checkConnection(); showToast("API Key Updated"); };
            DOM.topicInput.addEventListener('input', (e) => { state.config.topic = e.target.value; saveState(); });
            DOM.generateBtn.onclick = generateWorkflow;
            DOM.generateAudioBtn.onclick = generateAudio;
            DOM.generateVidBgBtn.onclick = generateVideoBackground;
            DOM.playCompositeBtn.onclick = playComposite;

            document.querySelectorAll('#output-tabs .tab-trigger').forEach(tab => {
                tab.onclick = () => {
                    document.querySelectorAll('#output-tabs .tab-trigger').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    state.activeTab = tab.dataset.tab;
                    renderScriptOutput();
                };
            });

            DOM.resetBtn.onclick = () => {
                if(confirm("Clear current production data?")) {
                    state.outputs = { script: '', hooks: '', scenes: [], seo: null, audioBlobUrl: null, videoBackgroundB64: null };
                    saveState(); location.reload();
                }
            };
        }
    </script>
</body>
</html>