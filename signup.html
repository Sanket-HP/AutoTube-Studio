<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoTube Studio | Pro AI Production</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Combined Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --yt-red: #ff0000;
            --bg-deep: #050505;
            --bg-surface: #0f0f0f;
            --border-muted: rgba(255,255,255,0.06);
            --yt-red-glow: rgba(255, 0, 0, 0.4);
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            color-scheme: dark;
        }

        body {
            font-family: 'Plus Jakarta Sans', 'Inter', sans-serif;
            background-color: var(--bg-deep);
            color: #fafafa;
            margin: 0;
            min-height: 100vh;
        }

        /* --- AUTH VIEW SPECIFIC --- */
        #auth-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            min-height: 100vh;
        }

        .auth-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            width: 100%;
            max-width: 850px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            animation: fadeInUp 0.8s ease-out;
        }

        @media (min-width: 768px) { .auth-card { flex-direction: row; } }

        .left-panel { flex: 1; padding: 32px; background: rgba(255, 0, 0, 0.03); border-right: 1px solid var(--glass-border); }
        .right-panel { flex: 1; padding: 32px; display: flex; flex-direction: column; justify-content: center; }

        .google-btn {
            background: white; color: #1a1a1a; font-weight: 700;
            display: flex; align-items: center; justify-content: center;
            gap: 12px; width: 100%; padding: 14px; border-radius: 12px;
            transition: all 0.3s ease; border: none; cursor: pointer;
        }
        .google-btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(0,0,0,0.2); }

        .logo-icon {
            width: 40px; height: 40px; background: var(--yt-red); border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 0 15px var(--yt-red);
        }
        .logo-icon::after {
            content: ''; width: 0; height: 0; border-top: 6px solid transparent;
            border-bottom: 6px solid transparent; border-left: 10px solid white; margin-left: 2px;
        }

        /* --- STUDIO VIEW SPECIFIC --- */
        #studio-app { display: none; height: 100vh; flex-direction: column; overflow: hidden; }

        .mesh-gradient {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -2;
            background: 
                radial-gradient(at 0% 0%, rgba(255, 0, 0, 0.08) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(255, 0, 0, 0.04) 0px, transparent 50%);
        }

        .glass-panel { background: rgba(18, 18, 18, 0.8); backdrop-filter: blur(24px); border: 1px solid var(--border-muted); }
        
        .sidebar-item { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); position: relative; color: #888888; }
        .sidebar-item.active { background: rgba(255, 0, 0, 0.08); color: #ffffff; }
        .sidebar-item.active::after {
            content: ''; position: absolute; left: 0; top: 25%; height: 50%; width: 3px;
            background: var(--yt-red); border-radius: 0 4px 4px 0; box-shadow: 0 0 10px var(--yt-red);
        }

        .input-field { background: #0a0a0a !important; border: 1px solid var(--border-muted) !important; color: white !important; }
        .input-field:focus { border-color: var(--yt-red) !important; outline: none; }

        .view-section { display: none; height: 100%; overflow-y: auto; padding-bottom: 100px; }
        .view-section.active { display: block; animation: fadeIn 0.4s ease-out; }

        #player-canvas-container {
            width: 100%; aspect-ratio: 16/9; background: #000; border-radius: 24px;
            position: relative; overflow: hidden; border: 1px solid var(--border-muted);
            box-shadow: 0 30px 60px -12px rgba(0, 0, 0, 0.8);
        }

        .active-scene-card { border-left: 3px solid var(--yt-red) !important; background: rgba(255,0,0,0.05) !important; transform: translateX(4px); }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .spinner {
            width: 18px; height: 18px; border: 2px solid rgba(255, 0, 0, 0.1);
            border-top: 2px solid var(--yt-red); border-radius: 50%;
            animation: spin 0.8s linear infinite; display: none;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="mesh-gradient"></div>

    <!-- VIEW 1: AUTHENTICATION SCREEN -->
    <div id="auth-screen">
        <div class="auth-card">
            <div class="left-panel">
                <div class="bg-red-600/10 text-red-600 text-[10px] font-bold px-3 py-1 rounded-full inline-block mb-4">Now in Public Beta</div>
                <div class="logo-icon mb-4"></div>
                <h2 class="text-3xl font-black mb-3">Create. Automate. <span class="text-red-600 italic">Dominate.</span></h2>
                <p class="text-zinc-500 text-xs leading-relaxed mb-6">
                    AutoTube Studio puts the power of full-scale AI YouTube automation in your hands. Generate scripts, visuals, and voices instantly.
                </p>
                <div class="space-y-3 mb-8">
                    <div class="flex items-center gap-2 text-[10px] font-bold text-zinc-400">
                        <span class="text-red-600">✓</span> 100% Client-Side Synthesis
                    </div>
                    <div class="flex items-center gap-2 text-[10px] font-bold text-zinc-400">
                        <span class="text-red-600">✓</span> Multi-Language Narration
                    </div>
                </div>
                <div class="aspect-video bg-zinc-900 rounded-xl border border-white/5 overflow-hidden shadow-2xl p-2">
                    <div class="w-full h-full bg-zinc-950 rounded-lg flex items-center justify-center relative group">
                        <div class="w-12 h-12 bg-red-600 rounded-full flex items-center justify-center text-white shadow-xl opacity-50 group-hover:opacity-100 transition-opacity">▶</div>
                        <div class="absolute bottom-2 left-2 right-2 h-1 bg-white/10 rounded-full overflow-hidden">
                            <div class="w-1/3 h-full bg-red-600"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="right-panel">
                <div class="text-center mb-8">
                    <h1 class="text-xl font-black mb-2 uppercase tracking-tight">Access Studio Node</h1>
                    <p class="text-xs text-zinc-500">Secure sign-in via Google Cloud Gateway</p>
                </div>
                <button id="googleBtn" class="google-btn" onclick="handleAuth()">
                    <svg width="18" height="18" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
                    <span id="btnText">Sign in with Google</span>
                    <div id="btnSpinner" class="spinner"></div>
                </button>
                <p class="mt-8 text-center text-[9px] text-zinc-600 uppercase tracking-[0.4em]">Encrypted Session Link</p>
            </div>
        </div>
    </div>

    <!-- VIEW 2: PRODUCTION STUDIO (Hidden by default) -->
    <div id="studio-app">
        <header class="h-16 border-b border-white/5 bg-black/40 backdrop-blur-xl flex items-center justify-between px-4 sm:px-8 shrink-0 z-50">
            <div class="flex items-center gap-4">
                <div class="w-9 h-9 bg-red-600 rounded-xl flex items-center justify-center">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect><path d="M10 15l4-3-4-3v6z" fill="white"></path></svg>
                </div>
                <div class="flex flex-col">
                    <span class="font-black tracking-tighter text-sm uppercase italic">AutoTube <span class="text-red-600">Studio</span></span>
                    <span class="text-[8px] font-black text-zinc-500 uppercase tracking-[0.2em]" id="user-display-name">Production Node v5.5</span>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <div class="flex items-center gap-2 px-3 py-1.5 rounded-full border border-zinc-800 bg-zinc-900/40">
                    <div id="status-dot" class="w-1.5 h-1.5 rounded-full bg-zinc-600"></div>
                    <span id="status-text" class="text-[9px] font-black text-zinc-500 uppercase tracking-widest">Idle</span>
                </div>
                <button onclick="handleLogout()" class="w-8 h-8 rounded-full overflow-hidden border border-white/10" title="Logout">
                    <img id="user-photo" src="" class="w-full h-full object-cover hidden">
                    <div id="user-photo-placeholder" class="w-full h-full bg-zinc-800 flex items-center justify-center text-[10px] font-bold">?</div>
                </button>
            </div>
        </header>

        <div class="flex flex-1 overflow-hidden">
            <aside class="w-64 border-r border-white/5 p-4 flex flex-col gap-2 bg-[#050505] shrink-0 z-40 hidden lg:flex">
                <nav class="flex flex-col flex-1 gap-1 mt-4">
                    <div id="nav-dashboard" onclick="switchPage('dashboard')" class="sidebar-item active flex items-center gap-3 p-4 rounded-xl cursor-pointer">
                        <span class="text-[10px] font-black uppercase tracking-widest">Dashboard</span>
                    </div>
                    <div id="nav-script" onclick="switchPage('script')" class="sidebar-item flex items-center gap-3 p-4 rounded-xl cursor-pointer">
                        <span class="text-[10px] font-black uppercase tracking-widest">Architect</span>
                    </div>
                    <div id="nav-audio" onclick="switchPage('audio')" class="sidebar-item flex items-center gap-3 p-4 rounded-xl cursor-pointer">
                        <span class="text-[10px] font-black uppercase tracking-widest">Voice Studio</span>
                    </div>
                    <div id="nav-production" onclick="switchPage('production')" class="sidebar-item flex items-center gap-3 p-4 rounded-xl cursor-pointer">
                        <span class="text-[10px] font-black uppercase tracking-widest">Mastering</span>
                    </div>
                </nav>
            </aside>

            <main class="flex-1 relative overflow-hidden bg-[#020202]">
                <!-- DASHBOARD VIEW -->
                <section id="view-dashboard" class="view-section active p-8 custom-scrollbar">
                    <div class="max-w-6xl mx-auto space-y-8">
                        <h1 class="text-3xl font-black text-white italic">Welcome Back</h1>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="glass-panel p-6 rounded-2xl">
                                <span class="text-[9px] font-black text-zinc-500 uppercase tracking-widest">Active Project</span>
                                <h3 id="dash-topic" class="text-sm font-bold mt-2 text-white">None</h3>
                            </div>
                            <div class="glass-panel p-6 rounded-2xl">
                                <span class="text-[9px] font-black text-zinc-500 uppercase tracking-widest">Audio Status</span>
                                <h3 id="dash-audio-status" class="text-sm font-bold mt-2 text-zinc-500">Waiting</h3>
                            </div>
                            <div class="glass-panel p-6 rounded-2xl">
                                <span class="text-[9px] font-black text-zinc-500 uppercase tracking-widest">Visual Status</span>
                                <h3 id="dash-video-status" class="text-sm font-bold mt-2 text-zinc-500">Idle</h3>
                            </div>
                        </div>
                        <div class="glass-panel rounded-3xl p-12 text-center border-dashed border-zinc-800 flex flex-col items-center">
                            <button onclick="switchPage('script')" class="px-10 py-4 bg-red-600 text-white font-black rounded-xl uppercase text-xs">New Production</button>
                        </div>
                    </div>
                </section>

                <!-- ARCHITECT VIEW -->
                <section id="view-script" class="view-section p-8 custom-scrollbar">
                    <div class="max-w-6xl mx-auto grid grid-cols-1 xl:grid-cols-12 gap-8">
                        <div class="xl:col-span-5 space-y-4">
                            <div class="glass-panel p-6 rounded-2xl">
                                <h3 class="text-[10px] font-black uppercase text-zinc-500 mb-4">API Gateway</h3>
                                <div class="flex gap-2">
                                    <input type="password" id="api-key-input" class="input-field flex-1 px-4 py-3 rounded-xl text-sm" placeholder="Gemini API Key">
                                    <button onclick="saveKey()" class="px-4 py-3 bg-white text-black font-black rounded-xl uppercase text-[10px]">Link</button>
                                </div>
                            </div>
                            <div class="glass-panel p-6 rounded-2xl space-y-4">
                                <h3 class="text-[10px] font-black uppercase text-zinc-500">Project Concept</h3>
                                <textarea id="topic-input" class="input-field w-full h-40 rounded-xl p-4 text-sm resize-none" placeholder="Video idea..."></textarea>
                                <button id="gen-script-btn" onclick="generateScript()" class="w-full py-4 bg-red-600 text-white font-black rounded-xl uppercase text-xs">Construct Blueprint</button>
                            </div>
                        </div>
                        <div class="xl:col-span-7">
                            <div class="glass-panel h-[500px] rounded-2xl flex flex-col overflow-hidden">
                                <div class="flex border-b border-zinc-800 bg-zinc-900/20">
                                    <button onclick="switchScriptTab('full')" id="tab-full" class="flex-1 py-3 text-[10px] font-black uppercase tracking-widest text-white border-b-2 border-red-600">Script</button>
                                    <button onclick="switchScriptTab('scenes')" id="tab-scenes" class="flex-1 py-3 text-[10px] font-black uppercase tracking-widest text-zinc-500">Storyboard</button>
                                </div>
                                <div id="script-viewport" class="flex-1 p-6 text-sm text-zinc-400 overflow-y-auto custom-scrollbar italic leading-relaxed">
                                    Awaiting architecture...
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- VOICE STUDIO VIEW -->
                <section id="view-audio" class="view-section p-8 custom-scrollbar">
                    <div class="max-w-4xl mx-auto glass-panel p-10 rounded-3xl grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="space-y-6">
                            <h3 class="text-2xl font-black italic">Voice Forge</h3>
                            <div class="space-y-4">
                                <select id="voice-name" class="input-field w-full p-4 rounded-xl text-sm font-bold">
                                    <optgroup label="Male Profiles"><option value="Zephyr">Zephyr (Deep)</option><option value="Charon">Charon (Bold)</option></optgroup>
                                    <optgroup label="Female Profiles"><option value="Kore">Kore (Bright)</option><option value="Aoede">Aoede (Gentle)</option></optgroup>
                                </select>
                                <input type="text" id="target-language" class="input-field w-full p-4 rounded-xl text-sm font-bold" placeholder="Language (e.g. Hindi, French)">
                                <button id="gen-audio-btn" onclick="generateAudio()" class="w-full py-4 bg-red-600 text-white font-black rounded-xl uppercase text-xs">Synthesize</button>
                            </div>
                        </div>
                        <div class="bg-black/50 rounded-2xl p-8 border border-zinc-800 flex flex-col items-center justify-center">
                            <div id="voice-loader" class="hidden w-12 h-12 border-4 border-red-600/10 border-t-red-600 rounded-full animate-spin mb-4"></div>
                            <div id="audio-container" class="hidden text-center space-y-4">
                                <p class="text-[10px] font-black text-green-500 uppercase tracking-widest">Narration Ready</p>
                                <button onclick="togglePlayback()" class="px-6 py-3 bg-white text-black font-black rounded-xl uppercase text-[10px]">Preview Audio</button>
                            </div>
                            <p id="voice-placeholder" class="text-[10px] text-zinc-700 uppercase tracking-widest">Awaiting Audio</p>
                        </div>
                    </div>
                </section>

                <!-- MASTERING VIEW -->
                <section id="view-production" class="view-section p-8 custom-scrollbar">
                    <div class="max-w-7xl mx-auto grid grid-cols-1 xl:grid-cols-12 gap-8">
                        <div class="xl:col-span-8 space-y-6">
                            <div id="player-canvas-container">
                                <canvas id="main-canvas" width="1280" height="720"></canvas>
                                <div id="video-placeholder" class="absolute inset-0 flex flex-col items-center justify-center opacity-20 pointer-events-none">
                                    <p class="text-xs font-black uppercase tracking-widest">No Frames in Buffer</p>
                                </div>
                            </div>
                            <div class="flex gap-4">
                                <button id="export-btn" onclick="exportMaster()" class="flex-1 py-5 bg-white text-black font-black rounded-2xl uppercase text-xs tracking-widest">Export WebM Master</button>
                                <div class="px-8 py-5 glass-panel rounded-2xl font-mono text-xl font-black" id="player-time">00:00.00</div>
                            </div>
                        </div>
                        <div class="xl:col-span-4 space-y-6">
                            <div class="glass-panel p-6 rounded-2xl space-y-4">
                                <h3 class="text-[10px] font-black text-zinc-500 uppercase tracking-widest">Asset Forge</h3>
                                <button onclick="generateVisuals()" id="gen-visuals-btn" class="w-full py-4 bg-zinc-900 text-white rounded-xl uppercase text-[10px] font-black">Forge Visuals</button>
                                <div id="asset-progress" class="flex gap-2 overflow-x-auto custom-scrollbar py-2"></div>
                            </div>
                        </div>
                    </div>
                </section>
            </main>

            <footer class="fixed bottom-0 left-0 right-0 h-12 bg-black/90 border-t border-white/5 backdrop-blur-xl flex items-center justify-between px-8 z-[100]">
                <div class="flex gap-6">
                    <div class="flex items-center gap-2"><div id="dot-script" class="w-1.5 h-1.5 rounded-full bg-zinc-800"></div><span class="text-[9px] font-bold text-zinc-600 uppercase">Script</span></div>
                    <div class="flex items-center gap-2"><div id="dot-audio" class="w-1.5 h-1.5 rounded-full bg-zinc-800"></div><span class="text-[9px] font-bold text-zinc-600 uppercase">Voice</span></div>
                    <div class="flex items-center gap-2"><div id="dot-visuals" class="w-1.5 h-1.5 rounded-full bg-zinc-800"></div><span class="text-[9px] font-bold text-zinc-600 uppercase">Media</span></div>
                </div>
                <span class="text-[9px] font-black text-zinc-800 uppercase tracking-widest">AU-5.5-MASTER</span>
            </footer>
        </div>
    </div>

    <!-- NOTIFICATION SYSTEM -->
    <div id="msg" class="fixed bottom-16 left-1/2 -translate-x-1/2 px-6 py-3 bg-zinc-900 border border-white/10 rounded-xl text-white text-xs font-bold hidden z-[1000] shadow-2xl"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global State & Firebase Config
        const firebaseConfig = JSON.parse(__firebase_config);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'autotube-studio';
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        window.state = {
            apiKey: '',
            activeScriptTab: 'full',
            production: { topic: '', blueprint: null, audioUrl: null, visuals: [], images: [], timings: [] },
            isPlaying: false, isRecording: false, currentIdx: -1
        };

        const masterAudio = new Audio();
        let audioCtx = null; let sourceNode = null; let mediaDest = null;
        const mainCanvas = document.getElementById('main-canvas');
        const mainCtx = mainCanvas.getContext('2d');

        // --- AUTHENTICATION LOGIC ---

        window.handleAuth = async () => {
            const btnText = document.getElementById('btnText');
            const btnSpinner = document.getElementById('btnSpinner');
            const googleBtn = document.getElementById('googleBtn');
            if (googleBtn.disabled) return;

            try {
                btnText.style.display = 'none';
                btnSpinner.style.display = 'block';
                googleBtn.disabled = true;

                const result = await signInWithPopup(auth, provider);
                const user = result.user;

                if (user) {
                    // RULE 1: Strict Paths
                    const userRef = doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'metadata');
                    await setDoc(userRef, {
                        displayName: user.displayName,
                        email: user.email,
                        photoURL: user.photoURL,
                        lastSeen: new Date().toISOString()
                    }, { merge: true });
                }
            } catch (error) {
                console.error(error);
                showMsg('Sign-in failed. Please try again.');
            } finally {
                btnText.style.display = 'block';
                btnSpinner.style.display = 'none';
                googleBtn.disabled = false;
            }
        };

        window.handleLogout = async () => {
            const ok = await customDialog("Sign Out", "All production progress in current session memory will be lost.", "Logout");
            if (ok) {
                window.state.production.visuals.forEach(url => URL.revokeObjectURL(url));
                sessionStorage.clear();
                await signOut(auth);
                location.reload();
            }
        };

        onAuthStateChanged(auth, (user) => {
            const authView = document.getElementById('auth-screen');
            const studioView = document.getElementById('studio-app');
            
            if (user) {
                authView.style.display = 'none';
                studioView.style.display = 'flex';
                document.getElementById('user-display-name').textContent = user.displayName || 'Creator';
                if (user.photoURL) {
                    document.getElementById('user-photo').src = user.photoURL;
                    document.getElementById('user-photo').classList.remove('hidden');
                    document.getElementById('user-photo-placeholder').classList.add('hidden');
                }
                showMsg(`Welcome, ${user.displayName.split(' ')[0]}! Node Active.`);
            } else {
                authView.style.display = 'flex';
                studioView.style.display = 'none';
            }
        });

        // --- PRODUCTION LOGIC ---

        window.showMsg = (text) => {
            const msg = document.getElementById('msg');
            msg.innerText = text;
            msg.style.display = 'block';
            setTimeout(() => { msg.style.display = 'none'; }, 4000);
        };

        window.customDialog = (title, body, confirmText = "Confirm") => {
            return new Promise((resolve) => {
                const m = document.getElementById('dialog-modal');
                document.getElementById('dialog-title').textContent = title;
                document.getElementById('dialog-body').textContent = body;
                document.getElementById('dialog-confirm').textContent = confirmText;
                m.classList.remove('hidden');
                const cleanup = (v) => { m.classList.add('hidden'); resolve(v); };
                document.getElementById('dialog-confirm').onclick = () => cleanup(true);
                document.getElementById('dialog-cancel').onclick = () => cleanup(false);
            });
        };

        async function apiCall(model, endpoint, payload, retries = 5) {
            const key = window.state.apiKey;
            if(!key) { showMsg("API Key Missing"); throw new Error("No Key"); }
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:${endpoint}?key=${key}`;
            for (let i = 0; i < retries; i++) {
                try {
                    const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (res.ok) return await res.json();
                    if (res.status === 429) await new Promise(r => setTimeout(r, Math.pow(2, i) * 1000));
                    else throw new Error("Service Error");
                } catch (e) { if (i === retries - 1) throw e; }
            }
        }

        window.saveKey = async () => {
            const val = document.getElementById('api-key-input').value.trim();
            window.state.apiKey = val;
            try {
                await apiCall('gemini-2.5-flash-preview-09-2025', 'generateContent', { contents: [{ parts: [{ text: "ping" }] }] });
                document.getElementById('status-dot').className = "w-1.5 h-1.5 rounded-full bg-green-500 shadow-[0_0_10px_green]";
                document.getElementById('status-text').textContent = "Handshake Ready";
                showMsg("Secure AI Gateway Verified");
            } catch (e) { showMsg("Gateway Check Failed"); }
        };

        window.generateScript = async () => {
            const topic = document.getElementById('topic-input').value.trim();
            if(!topic) return showMsg("Input Idea");
            const btn = document.getElementById('gen-script-btn');
            btn.disabled = true; btn.textContent = "Synthesizing...";
            const prompt = `Return valid JSON only. Topic: "${topic}". Structure: {"title": "Title", "full_text": "Narration", "scenes": [{"narration": "sentence", "prompt": "16:9 photo prompt"}], "seo": {"tags": "tags"}}.`;
            try {
                const data = await apiCall('gemini-2.5-flash-preview-09-2025', 'generateContent', { contents: [{ parts: [{ text: topic }] }], systemInstruction: { parts: [{ text: prompt }] }, generationConfig: { responseMimeType: "application/json" } });
                const blueprint = JSON.parse(data.candidates[0].content.parts[0].text.replace(/```json|```/gi, '').trim());
                window.state.production.blueprint = blueprint;
                window.state.production.topic = topic;
                document.getElementById('dot-script').className = "w-1.5 h-1.5 rounded-full bg-green-500";
                renderView();
                showMsg("Script Blueprint Constructed");
            } catch (e) { showMsg("Architect Error"); }
            finally { btn.disabled = false; btn.textContent = "Construct Blueprint"; }
        };

        window.generateAudio = async () => {
            if (!window.state.production.blueprint) return showMsg("No Blueprint");
            const btn = document.getElementById('gen-audio-btn');
            document.getElementById('voice-loader').classList.remove('hidden');
            document.getElementById('voice-placeholder').classList.add('hidden');
            try {
                let text = window.state.production.blueprint.scenes.map(s => s.narration).join(' ');
                const lang = document.getElementById('target-language').value.trim();
                if (lang) text = `Translate to ${lang} and narrate: ${text}`;
                const data = await apiCall('gemini-2.5-flash-preview-tts', 'generateContent', { contents: [{ parts: [{ text: text }] }], generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: document.getElementById('voice-name').value } } } } });
                const base64 = data.candidates[0].content.parts.find(p => p.inlineData).inlineData.data;
                const binary = atob(base64); const bytes = new Uint8Array(binary.length);
                for(let i=0; i<binary.length; i++) bytes[i] = binary.charCodeAt(i);
                window.state.production.audioUrl = URL.createObjectURL(new Blob([createWav(bytes, 24000)], {type: 'audio/wav'}));
                masterAudio.src = window.state.production.audioUrl;
                masterAudio.onloadedmetadata = () => {
                    const dur = masterAudio.duration;
                    const weights = window.state.production.blueprint.scenes.map(s => s.narration.length + (s.narration.match(/[,.!?]/g) || []).length * 50);
                    const totalWeight = weights.reduce((a, b) => a + b, 0);
                    let elapsed = 0;
                    window.state.production.timings = weights.map(w => { const sceneDur = (w / totalWeight) * dur; const t = { start: elapsed, end: elapsed + sceneDur }; elapsed += sceneDur; return t; });
                    document.getElementById('audio-container').classList.remove('hidden');
                    document.getElementById('dot-audio').className = "w-1.5 h-1.5 rounded-full bg-green-500";
                    renderView();
                };
            } catch (e) { showMsg("Audio Synth Error"); }
            finally { document.getElementById('voice-loader').classList.add('hidden'); }
        };

        window.generateVisuals = async () => {
            if (!window.state.production.blueprint) return showMsg("No Blueprint");
            const btn = document.getElementById('gen-visuals-btn');
            const gallery = document.getElementById('asset-progress');
            btn.disabled = true; gallery.innerHTML = '';
            const scenes = window.state.production.blueprint.scenes;
            window.state.production.images = [];
            for (let i = 0; i < scenes.length; i++) {
                const thumb = document.createElement('div'); thumb.className = "asset-thumb loading"; gallery.appendChild(thumb);
                try {
                    const data = await apiCall('imagen-4.0-generate-001', 'predict', { instances: { prompt: `Cinematic 16:9, ${scenes[i].prompt}` }, parameters: { sampleCount: 1 } });
                    const b64 = data.predictions[0].bytesBase64Encoded;
                    const url = URL.createObjectURL(new Blob([new Uint8Array(atob(b64).split('').map(c => c.charCodeAt(0)))], {type: 'image/png'}));
                    window.state.production.visuals[i] = url;
                    const img = new Image(); img.src = url; await img.decode();
                    window.state.production.images[i] = img;
                    thumb.classList.remove('loading'); thumb.innerHTML = `<img src="${url}" class="w-full h-full object-cover">`;
                    if(i === 0) drawFrame(0);
                } catch (e) { thumb.style.borderColor = "red"; }
            }
            document.getElementById('dot-visuals').className = "w-1.5 h-1.5 rounded-full bg-green-500";
            btn.disabled = false; document.getElementById('video-placeholder').classList.add('hidden');
            renderView();
        };

        function drawFrame(idx, text = "") {
            const img = window.state.production.images[idx];
            if (!img) return;
            mainCtx.fillStyle = "#000"; mainCtx.fillRect(0, 0, 1280, 720);
            const ratio = Math.max(1280 / img.width, 720 / img.height);
            const w = img.width * ratio; const h = img.height * ratio;
            mainCtx.drawImage(img, (1280 - w) / 2, (720 - h) / 2, w, h);
            if (text) {
                mainCtx.fillStyle = "rgba(0,0,0,0.7)"; mainCtx.roundRect(140, 580, 1000, 100, 20); mainCtx.fill();
                mainCtx.fillStyle = "white"; mainCtx.font = "bold 32px 'Plus Jakarta Sans'"; mainCtx.textAlign = "center";
                mainCtx.fillText(text, 640, 640);
            }
        }

        window.togglePlayback = () => {
            if (window.state.isPlaying) { masterAudio.pause(); window.state.isPlaying = false; }
            else { masterAudio.currentTime = 0; masterAudio.play().then(() => { window.state.isPlaying = true; requestAnimationFrame(renderLoop); }); }
        };

        function renderLoop() {
            if (!window.state.isPlaying && !window.state.isRecording) return;
            const time = masterAudio.currentTime;
            document.getElementById('player-time').textContent = formatTimer(time);
            const timings = window.state.production.timings;
            let idx = timings.findIndex(t => time >= t.start && time < t.end);
            if (idx === -1 && time > 0) idx = timings.length - 1;
            if (idx !== -1 && window.state.currentIdx !== idx) {
                window.state.currentIdx = idx;
                drawFrame(idx, window.state.production.blueprint.scenes[idx].narration);
            }
            if (masterAudio.ended) window.state.isPlaying = false;
            else requestAnimationFrame(renderLoop);
        }

        window.exportMaster = async () => {
            if (window.state.isRecording || !window.state.production.images.length) return;
            if (!audioCtx) { audioCtx = new AudioContext(); mediaDest = audioCtx.createMediaStreamDestination(); sourceNode = audioCtx.createMediaElementSource(masterAudio); sourceNode.connect(mediaDest); sourceNode.connect(audioCtx.destination); }
            window.state.isRecording = true;
            const recorder = new MediaRecorder(new MediaStream([...mainCanvas.captureStream(30).getVideoTracks(), ...mediaDest.stream.getAudioTracks()]), { mimeType: 'video/webm' });
            const chunks = []; recorder.ondataavailable = e => chunks.push(e.data);
            recorder.onstop = () => { const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob(chunks, { type: 'video/webm' })); a.download = "Master.webm"; a.click(); window.state.isRecording = false; };
            masterAudio.currentTime = 0; masterAudio.play(); recorder.start();
            const track = () => { if(window.state.isRecording) { renderLoop(); if(masterAudio.ended) recorder.stop(); else requestAnimationFrame(track); } }; track();
        };

        window.switchPage = (page) => {
            document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.sidebar-item').forEach(s => s.classList.remove('active'));
            document.getElementById(`view-${page}`).classList.add('active');
            if(document.getElementById(`nav-${page}`)) document.getElementById(`nav-${page}`).classList.add('active');
            renderView();
        };

        window.renderView = () => {
            const p = window.state.production;
            document.getElementById('dash-topic').textContent = p.topic || 'None';
            if (p.blueprint) {
                document.getElementById('dash-script-status').textContent = "Synthesized";
                const vp = document.getElementById('script-viewport');
                vp.classList.remove('italic');
                vp.textContent = window.state.activeScriptTab === 'full' ? p.blueprint.full_text : p.blueprint.scenes.map(s => s.narration).join('\n\n');
            }
            document.getElementById('dash-audio-status').textContent = p.audioUrl ? "Ready" : "Waiting";
            document.getElementById('dash-video-status').textContent = p.visuals.length ? "Forged" : "Idle";
        };

        function formatTimer(s) { const m = Math.floor(s/60), sec = Math.floor(s%60), ms = Math.floor((s%1)*100); return `${m.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}.${ms.toString().padStart(2,'0')}`; }
        function createWav(pcm, rate) {
            const h = new ArrayBuffer(44), v = new DataView(h);
            const s = (o, str) => { for(let i=0; i<str.length; i++) v.setUint8(o+i, str.charCodeAt(i)); };
            s(0, 'RIFF'); v.setUint32(4, 36 + pcm.length, true); s(8, 'WAVE'); s(12, 'fmt ');
            v.setUint32(16, 16, true); v.setUint16(20, 1, true); v.setUint16(22, 1, true);
            v.setUint32(24, rate, true); v.setUint32(28, rate * 2, true); v.setUint16(32, 2, true); v.setUint16(34, 16, true);
            s(36, 'data'); v.setUint32(40, pcm.length, true); return new Uint8Array([...new Uint8Array(h), ...pcm]);
        }
        window.switchScriptTab = (t) => { window.state.activeScriptTab = t; renderView(); };
    </script>

    <!-- MODAL -->
    <div id="dialog-modal" class="hidden fixed inset-0 z-[200] bg-black/90 backdrop-blur-md flex items-center justify-center p-6">
        <div class="glass-panel max-w-md w-full rounded-3xl p-10 text-center border border-white/5">
            <h3 id="dialog-title" class="text-2xl font-black text-white italic mb-4">Notice</h3>
            <p id="dialog-body" class="text-sm text-zinc-500 mb-10"></p>
            <div class="flex gap-3">
                <button id="dialog-cancel" class="flex-1 py-4 bg-zinc-900 text-[11px] font-black uppercase tracking-widest text-zinc-400 rounded-2xl">Abort</button>
                <button id="dialog-confirm" class="flex-1 py-4 bg-red-600 text-[11px] font-black uppercase tracking-widest text-white rounded-2xl">Proceed</button>
            </div>
        </div>
    </div>
</body>
</html>